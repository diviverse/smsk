<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <title>İstanbul Ulaşım</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      rel="icon"
      type="image/svg+xml"
      href="https://upload.wikimedia.org/wikipedia/commons/8/82/IAFL_Logo_%28SVG%29.svg"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />

    <style>
      :root {
        --primary-color: #2563eb;
        --secondary-color: #f8fafc;
        --border-color: #e5e7eb;
        --text-dark: #1f2937;
        --text-light: #6b7280;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background-color: #f8fafc;
        height: 100vh;
        overflow: hidden;
      }

      .main-container {
        height: 100vh;
        display: flex;
        flex-direction: row;
      }

      .sidebar {
        background: white;
        border-right: 1px solid var(--border-color);
        overflow-y: auto;
        transition: all 0.3s ease;
      }

      .map-container {
        flex: 1;
        position: relative;
        background: #e5e7eb;
      }

      #map {
        width: 100%;
        height: 100%;
      }

      .section-card {
        background: var(--secondary-color);
        border-radius: 12px;
        margin-bottom: 16px;
        overflow: hidden;
        border: 1px solid var(--border-color);
      }

      .section-header {
        padding: 16px 20px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
        background: white;
        transition: background-color 0.2s ease;
      }

      .section-header:hover {
        background-color: var(--secondary-color);
      }

      .section-content {
        padding: 0 20px;
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: max-height 0.35s ease, opacity 0.25s ease,
          padding 0.25s ease;
      }

      .section-card.open .section-content {
        padding: 16px 20px;
        max-height: 600px;
        opacity: 1;
      }

      .section-header i {
        transition: transform 0.25s ease;
      }

      .section-card.open .section-header i {
        transform: rotate(90deg);
      }

      .form-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 6px;
      }

      .form-control,
      .form-select {
        border-radius: 10px;
        border: 1px solid var(--border-color);
        padding: 10px 14px;
        font-size: 14px;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .btn-primary {
        background-color: var(--primary-color);
        border: none;
        border-radius: 999px;
        padding: 10px 20px;
        font-weight: 600;
        transition: all 0.2s ease;
      }

      .btn-primary:hover {
        background-color: #1d4ed8;
        transform: translateY(-1px);
      }

      .search-results {
        max-height: 200px;
        overflow-y: auto;
      }

      .search-result-item {
        padding: 10px 12px;
        cursor: pointer;
        border-radius: 8px;
        font-size: 13px;
        margin-bottom: 4px;
        transition: background-color 0.2s ease;
      }

      .search-result-item:hover {
        background-color: #e5e7eb;
      }

      .point-display {
        background: #e9eef5;
        padding: 12px;
        border-radius: 10px;
        font-size: 13px;
        margin-bottom: 10px;
        border-left: 4px solid var(--primary-color);
      }

      .floating-result {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 16px 24px;
        border-radius: 999px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        font-weight: 600;
        font-size: 14px;
        z-index: 1000;
        min-width: 300px;
        text-align: center;
        backdrop-filter: blur(10px);
      }

      .mobile-toggle {
        display: none;
        position: absolute;
        top: 20px;
        left: 15px;
        z-index: 1000;
        background: white;
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      @media (min-width: 769px) {
        .sidebar {
          min-width: 300px;
          width: 30%;
        }
      }

      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          top: 0;
          left: -100%;
          width: 85%;
          max-width: 350px;
          height: 100vh;
          z-index: 1050;
          box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
        }

        .sidebar.show {
          left: 0;
        }

        .mobile-toggle {
          display: block;
        }

        .floating-result {
          font-size: 13px;
          padding: 12px 16px;
          min-width: 250px;
        }

        .map-container {
          width: 100%;
        }
      }

      @media (max-width: 480px) {
        .floating-result {
          font-size: 12px;
          padding: 10px 14px;
          min-width: 200px;
        }
      }

      .sidebar::-webkit-scrollbar {
        width: 6px;
      }

      .sidebar::-webkit-scrollbar-track {
        background: #f1f1f1;
      }

      .sidebar::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
      }

      .sidebar::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <!-- Mobile Toggle Button -->
      <button class="mobile-toggle" id="mobileToggle">
        <i class="bi bi-list fs-2"></i>
      </button>

      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <div class="p-4">
          <h1 class="h4 mb-4 text-dark fw-bold">
            <i class="bi bi-bus-front text-primary me-2"></i>
            İstanbul Ulaşım
          </h1>

          <!-- Search Section -->
          <div class="section-card open">
            <div class="section-header" onclick="toggleSection(this)">
              <span
                ><i class="bi bi-geo-alt text-primary me-2"></i>Yer Arama</span
              >
              <i class="bi bi-chevron-right text-muted"></i>
            </div>
            <div class="section-content">
              <div class="mb-3">
                <label class="form-label">Başlangıç (A)</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="searchA"
                    placeholder="Örn: Kadıköy"
                  />
                  <button
                    class="btn btn-primary"
                    type="button"
                    onclick="runSearch('A')"
                  >
                    <i class="bi bi-search"></i>
                  </button>
                </div>
                <div id="resultsA" class="search-results mt-2"></div>
              </div>

              <div class="mb-3">
                <label class="form-label">Varış (B)</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="searchB"
                    placeholder="Örn: Beşiktaş"
                  />
                  <button
                    class="btn btn-primary"
                    type="button"
                    onclick="runSearch('B')"
                  >
                    <i class="bi bi-search"></i>
                  </button>
                </div>
                <div id="resultsB" class="search-results mt-2"></div>
              </div>
            </div>
          </div>

          <!-- Selected Points Section -->
          <div class="section-card open">
            <div class="section-header" onclick="toggleSection(this)">
              <span
                ><i class="bi bi-pin-map text-primary me-2"></i>Seçilen
                Noktalar</span
              >
              <i class="bi bi-chevron-right text-muted"></i>
            </div>
            <div class="section-content">
              <div class="point-display" id="startDisplay">
                <i class="bi bi-circle-fill text-success me-2"></i>A: seçilmedi
              </div>
              <div class="point-display" id="endDisplay">
                <i class="bi bi-circle-fill text-danger me-2"></i>B: seçilmedi
              </div>
              <button class="btn btn-outline-secondary w-100" id="resetBtn">
                <i class="bi bi-arrow-clockwise me-2"></i>Noktaları Sıfırla
              </button>
            </div>
          </div>

          <!-- Date & Time Section -->
          <div class="section-card">
            <div class="section-header" onclick="toggleSection(this)">
              <span
                ><i class="bi bi-calendar3 text-primary me-2"></i>Tarih &
                Saat</span
              >
              <i class="bi bi-chevron-right text-muted"></i>
            </div>
            <div class="section-content">
              <div class="mb-3">
                <label class="form-label">Tarih</label>
                <input type="date" class="form-control" id="dateInput" />
              </div>
              <div class="mb-3">
                <label class="form-label">Saat</label>
                <input type="time" class="form-control" id="timeInput" />
              </div>
            </div>
          </div>

          <!-- Transfer Section -->
          <div class="section-card">
            <div class="section-header" onclick="toggleSection(this)">
              <span
                ><i class="bi bi-arrow-left-right text-primary me-2"></i
                >Aktarma</span
              >
              <i class="bi bi-chevron-right text-muted"></i>
            </div>
            <div class="section-content">
              <div class="mb-3">
                <label class="form-label">Aktarma Sayısı</label>
                <select class="form-select" id="transferCount">
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Kaçırılan Aktarma</label>
                <select class="form-select" id="missedTransfer">
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Map Container -->
      <div class="map-container">
        <div id="map"></div>
        <div class="floating-result" id="resultBox">
          <i class="bi bi-info-circle me-2"></i>Hesaplama yok
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.min.js"></script>

    <script>
      /* ---------- COLLAPSIBLE ---------- */
      function toggleSection(header) {
        const section = header.parentElement;
        const icon = header.querySelector("i.bi-chevron-right");
        section.classList.toggle("open");
      }

      /* ---------- MAP ---------- */
      const istanbulBounds = [
        [40.75, 28.5],
        [41.45, 29.5],
      ];

      const map = L.map("map", {
        center: [41.0082, 28.9784],
        zoom: 11,
        maxBounds: istanbulBounds,
        maxBoundsViscosity: 1.0,
        minZoom: 9,
        maxZoom: 17,
        zoomControl: false,
      });
      L.control
        .zoom({
          position: "bottomleft",
        })
        .addTo(map);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap",
        bounds: istanbulBounds,
      }).addTo(map);

      let startMarker = null,
        endMarker = null,
        line = null;

      /* ---------- DEFAULT TIME ---------- */
      document.getElementById("dateInput").valueAsDate = new Date();
      document.getElementById("timeInput").value = new Date()
        .toTimeString()
        .slice(0, 5);

      /* ---------- MOBILE SIDEBAR TOGGLE ---------- */
      const mobileToggle = document.getElementById("mobileToggle");
      const sidebar = document.getElementById("sidebar");

      mobileToggle.addEventListener("click", () => {
        sidebar.classList.toggle("show");
      });

      document.addEventListener("click", (e) => {
        if (
          window.innerWidth <= 768 &&
          !sidebar.contains(e.target) &&
          !mobileToggle.contains(e.target)
        ) {
          sidebar.classList.remove("show");
        }
      });

      /* ---------- CALCULATION ---------- */
      function calculateTravelTime(settings) {
        return Math.floor(15 + Math.random() * 45);
      }

      function recalc() {
        if (!startMarker || !endMarker) return;

        const startDT = new Date(
          `${document.getElementById("dateInput").value}T${
            document.getElementById("timeInput").value
          }`
        );
        const duration = calculateTravelTime({});
        const arrival = new Date(startDT.getTime() + duration * 60000);

        document.getElementById(
          "resultBox"
        ).innerHTML = `<i class="bi bi-clock me-2"></i>${duration} dk &nbsp;&nbsp;→&nbsp;&nbsp; 
           <i class="bi bi-calendar-check me-2"></i>${arrival.toLocaleTimeString(
             "tr-TR",
             { hour: "2-digit", minute: "2-digit" }
           )}`;
      }

      /* ---------- MARKERS ---------- */
      function setMarker(type, lat, lon, label) {
        const marker = L.marker([lat, lon]).addTo(map);

        if (type === "A") {
          if (startMarker) map.removeLayer(startMarker);
          startMarker = marker;
          document.getElementById(
            "startDisplay"
          ).innerHTML = `<i class="bi bi-circle-fill text-success me-2"></i>A: ${label}`;
        } else {
          if (endMarker) map.removeLayer(endMarker);
          endMarker = marker;
          document.getElementById(
            "endDisplay"
          ).innerHTML = `<i class="bi bi-circle-fill text-danger me-2"></i>B: ${label}`;
        }

        if (line) map.removeLayer(line);
        if (startMarker && endMarker) {
          const group = new L.featureGroup([startMarker, endMarker]);
          map.fitBounds(group.getBounds().pad(0.1));

          const latlngs = [startMarker.getLatLng(), endMarker.getLatLng()];

          line = L.polyline(latlngs, {
            color: "#2563eb",
            weight: 4,
            opacity: 0.3,
          }).addTo(map);

          L.polylineDecorator(line, {
            patterns: [
              {
                offset: 15,
                repeat: 15,
                symbol: L.Symbol.arrowHead({
                  pixelSize: 10,
                  pathOptions: {
                    fill: true,
                    fillColor: "#2563eb",
                    fillOpacity: 0.8,
                    weight: 2,
                    color: "#2563eb",
                  },
                }),
              },
            ],
          }).addTo(map);
        }

        recalc();

        const key = type === "A" ? "istanbulA" : "istanbulB";
        localStorage.setItem(key, JSON.stringify({ lat, lon, label }));
      }

      /* ---------- SEARCH ---------- */
      async function runSearch(type) {
        const input =
          type === "A"
            ? document.getElementById("searchA")
            : document.getElementById("searchB");
        const container =
          type === "A"
            ? document.getElementById("resultsA")
            : document.getElementById("resultsB");
        const q = input.value.trim();
        if (!q) return;

        const url =
          `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1` +
          `&q=${encodeURIComponent(q + ", Istanbul")}` +
          `&countrycodes=tr&bounded=1` +
          `&viewbox=28.4,41.3,29.5,40.8&limit=5`;

        try {
          const res = await fetch(url);
          const data = await res.json();
          if (!Array.isArray(data)) return;

          container.innerHTML = "";
          data.forEach((p) => {
            const div = document.createElement("div");
            div.className = "search-result-item";
            div.innerHTML = `<i class="bi bi-geo-alt text-primary me-2"></i>${p.display_name}`;
            div.onclick = () => setMarker(type, p.lat, p.lon, p.display_name);
            container.appendChild(div);
          });
        } catch (error) {
          console.error("Search error:", error);
        }
      }

      function debounce(fn, ms = 250) {
        let t;
        return function (...args) {
          clearTimeout(t);
          t = setTimeout(() => fn.apply(this, args), ms);
        };
      }

      /* ---------- EVENTS ---------- */
      ["searchA", "searchB"].forEach((id) => {
        const input = document.getElementById(id);
        const type = id === "searchA" ? "A" : "B";

        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") runSearch(type);
        });

        input.addEventListener(
          "input",
          debounce(() => runSearch(type), 250)
        );
      });

      ["dateInput", "timeInput", "transferCount", "missedTransfer"].forEach(
        (id) => {
          document.getElementById(id).addEventListener("change", recalc);
        }
      );

      document.getElementById("resetBtn").onclick = () => {
        [startMarker, endMarker, line].forEach((l) => l && map.removeLayer(l));
        startMarker = endMarker = line = null;
        document.getElementById(
          "startDisplay"
        ).innerHTML = `<i class="bi bi-circle-fill text-success me-2"></i>A: seçilmedi`;
        document.getElementById(
          "endDisplay"
        ).innerHTML = `<i class="bi bi-circle-fill text-danger me-2"></i>B: seçilmedi`;
        document.getElementById(
          "resultBox"
        ).innerHTML = `<i class="bi bi-info-circle me-2"></i>Hesaplama yok`;

        map.setView([41.0082, 28.9784], 11);
        localStorage.removeItem("istanbulA");
        localStorage.removeItem("istanbulB");
      };

      window.addEventListener("resize", () => {
        map.invalidateSize();
      });

      (function restoreMarkers() {
        const savedA = localStorage.getItem("istanbulA");
        const savedB = localStorage.getItem("istanbulB");

        if (savedA) {
          const { lat, lon, label } = JSON.parse(savedA);
          setMarker("A", lat, lon, label);
        }
        if (savedB) {
          const { lat, lon, label } = JSON.parse(savedB);
          setMarker("B", lat, lon, label);
        }
      })();
    </script>
  </body>
</html>

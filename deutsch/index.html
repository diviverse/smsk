<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title class="notranslate">Germanist</title>
    <meta
      name="description"
      content="Professionelle Verbkonjugation und Grammatikpr√ºfung f√ºr Deutschlernende."
    />

    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://deutsh.smsk.one" />
    <meta property="og:title" content="Germanist" />
    <meta
      property="og:description"
      content="Professionelle Verbkonjugation und Grammatikpr√ºfung f√ºr Deutschlernende."
    />
    <meta property="og:locale" content="de_DE" />
    <meta property="og:site_name" content="Germanist" />

    <meta name="author" content="Germanist" />
    <meta
      name="keywords"
      content="Deutsch, Verb, Konjugation, Grammatik, Deutsch lernen, German verbs, conjugation"
    />
    <meta name="theme-color" content="#3b82f6" />

    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link href="style.css" rel="stylesheet" />
  </head>
  <body>
    <header class="header">
      <div class="particle-system"></div>
      <div class="container-final-final-enhanced">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <h1 class="h4 mb-0 display-font notranslate">
              <i
                class="fas fa-globe me-1"
                style="
                  background: url('/favicon.ico');
                  -webkit-background-clip: text;
                  background-clip: text;
                  background-size: 100% 100%;
                  color: transparent;
                "
              ></i>
              Germanist
            </h1>
            <small class="text-white-50 header-description"
              >Professionelle Verbkonjugation und Grammatikpr√ºfung f√ºr
              Deutschlernende</small
            >
          </div>
          <div class="d-flex gap-3 align-items-center">
            <div class="dark-mode-toggle-final-final-enhanced">
              <input
                type="checkbox"
                id="themeToggle"
                class="form-check-input"
              />
              <div class="dark-mode-slider-final-final-enhanced">
                <i class="fas fa-sun slider-icon-light"></i>
                <i class="fas fa-moon slider-icon-dark"></i>
              </div>
              <div class="toggle-icons-final-final-enhanced">
                <i class="fas fa-sun"></i>
                <i class="fas fa-moon"></i>
              </div>
            </div>
            <button
              class="btn btn-outline-light btn-custom final-final-touch"
              onclick="showHelp()"
            >
              <i class="fas fa-question-circle"></i>&nbsp;Hilfe
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="container-final-final-enhanced mb-5">
      <div class="tab-navigation mb-4">
        <div class="card">
          <div class="card-body p-3">
            <div class="d-flex align-items-center justify-content-between">
              <ul class="nav nav-tabs nav-tabs-custom" role="tablist">
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link active"
                    id="conjugation-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#conjugation-pane"
                    type="button"
                    role="tab"
                    aria-controls="conjugation-pane"
                    aria-selected="true"
                    onclick="switchTab('conjugation')"
                  >
                    <i class="fas fa-book"></i>&nbsp;Konjugation
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="grammar-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#grammar-pane"
                    type="button"
                    role="tab"
                    aria-controls="grammar-pane"
                    aria-selected="false"
                    onclick="switchTab('grammar')"
                  >
                    <i class="fas fa-spell-check"></i>&nbsp;Grammatikpr√ºfung
                  </button>
                </li>
                <li class="nav-item" role="presentation" style="display: none">
                  <button
                    class="nav-link"
                    id="vocabulary-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#vocabulary-pane"
                    type="button"
                    role="tab"
                    aria-controls="vocabulary-pane"
                    aria-selected="false"
                    onclick="switchTab('vocabulary')"
                  >
                    <i class="fas fa-graduation-cap"></i>&nbsp;Vokabeltrainer
                  </button>
                </li>
              </ul>
              <small class="text-muted coming-soon-text">
                <i class="fas fa-rocket"></i>&nbsp;Weitere Features kommen bald
              </small>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-content">
        <div
          class="tab-pane fade show active"
          id="conjugation-pane"
          role="tabpanel"
          aria-labelledby="conjugation-tab"
        >
          <div class="row">
            <div class="col-lg-4 mb-4">
              <div class="card mb-4 fade-in-up">
                <div class="card-header bg-gradient-primary text-white">
                  <strong
                    ><i class="fas fa-plus-circle"></i>&nbsp;Verb
                    Hinzuf√ºgen</strong
                  >
                </div>
                <div class="card-body">
                  <ul class="nav nav-tabs nav-tabs-small mb-3" role="tablist">
                    <li class="nav-item" role="presentation">
                      <button
                        class="nav-link active"
                        id="single-verb-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#single-verb-pane"
                        type="button"
                        role="tab"
                      >
                        <i class="fas fa-plus"></i>&nbsp;Einzeln hinzuf√ºgen
                      </button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button
                        class="nav-link"
                        id="text-paste-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#text-paste-pane"
                        type="button"
                        role="tab"
                      >
                        <i class="fas fa-paste"></i>&nbsp;Text einf√ºgen
                      </button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button
                        class="nav-link"
                        id="file-upload-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#file-upload-pane"
                        type="button"
                        role="tab"
                      >
                        <i class="fas fa-file"></i>&nbsp;Datei hochladen
                      </button>
                    </li>
                    <li class="nav-item ms-auto">
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-info p-1"
                        data-bs-toggle="modal"
                        data-bs-target="#bulkUploadHelpModal"
                        title="Hilfe"
                        style="
                          width: 24px;
                          height: 24px;
                          padding: 0;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                        "
                      >
                        <i
                          class="fas fa-question-circle"
                          style="font-size: 12px"
                        ></i>
                      </button>
                    </li>
                  </ul>

                  <div class="tab-content">
                    <div
                      class="tab-pane fade show active"
                      id="single-verb-pane"
                      role="tabpanel"
                    >
                      <form id="verbForm" class="enhanced-spacing">
                        <div class="mb-3">
                          <label for="verbInput" class="form-label"
                            >Verb (Infinitiv)</label
                          >
                          <input
                            id="verbInput"
                            class="form-control optimize-legibility notranslate"
                            placeholder="z.B. gehen, machen, lernen"
                            autocapitalize="off"
                            autocorrect="off"
                            spellcheck="false"
                            inputmode="text"
                          />
                          <div class="form-text">
                            Geben Sie ein deutsches Verb im Infinitiv ein.
                          </div>
                        </div>
                        <div class="mb-3">
                          <label for="turkishMeaning" class="form-label"
                            >T√ºrkische Bedeutung (Optional)</label
                          >
                          <input
                            id="turkishMeaning"
                            class="form-control optimize-legibility notranslate"
                            placeholder="z.B. gitmek, yapmak, √∂ƒürenmek"
                            autocapitalize="off"
                          />
                        </div>
                        <button
                          type="submit"
                          class="btn btn-primary-custom btn-custom final-final-touch w-100"
                        >
                          <i class="fas fa-plus"></i>&nbsp;Verb Hinzuf√ºgen
                        </button>
                      </form>
                    </div>

                    <div
                      class="tab-pane fade"
                      id="file-upload-pane"
                      role="tabpanel"
                    >
                      <div class="mb-3">
                        <label for="verbFileInput" class="form-label"
                          >Datei ausw√§hlen (TXT oder XLSX)</label
                        >
                        <input
                          type="file"
                          id="verbFileInput"
                          class="form-control"
                          accept=".txt,.xlsx"
                        />
                        <div class="form-text">
                          Unterst√ºtzte Formate: TXT, XLSX
                        </div>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Import-Optionen</label>
                        <div class="form-check mb-2">
                          <input
                            class="form-check-input"
                            type="radio"
                            name="importMode"
                            id="importAppend"
                            value="append"
                            checked
                          />
                          <label class="form-check-label" for="importAppend">
                            Zu Liste hinzuf√ºgen
                          </label>
                        </div>
                        <div class="form-check mb-2">
                          <input
                            class="form-check-input"
                            type="radio"
                            name="importMode"
                            id="importReplace"
                            value="replace"
                          />
                          <label class="form-check-label" for="importReplace">
                            Liste ersetzen
                          </label>
                        </div>
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            id="skipDuplicates"
                            checked
                          />
                          <label class="form-check-label" for="skipDuplicates">
                            Duplikate √ºberspringen
                          </label>
                        </div>
                      </div>

                      <button
                        type="button"
                        class="btn btn-success-custom btn-custom final-final-touch w-100"
                        onclick="processBulkImport()"
                        id="bulkImportBtn"
                      >
                        <i class="fas fa-upload"></i>&nbsp;Verben importieren
                      </button>
                    </div>

                    <div
                      class="tab-pane fade"
                      id="text-paste-pane"
                      role="tabpanel"
                    >
                      <div class="mb-3">
                        <label for="bulkTextInput" class="form-label"
                          >Verben einf√ºgen</label
                        >
                        <textarea
                          id="bulkTextInput"
                          class="form-control"
                          rows="5"
                          placeholder="F√ºgen Sie hier Ihren Text ein. Alle W√∂rter werden automatisch erkannt..."
                        ></textarea>
                        <div class="form-text">
                          Alle W√∂rter im Text werden automatisch erkannt und
                          hinzugef√ºgt.
                        </div>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Import-Optionen</label>
                        <div class="form-check mb-2">
                          <input
                            class="form-check-input"
                            type="radio"
                            name="importMode"
                            id="importAppend2"
                            value="append"
                            checked
                          />
                          <label class="form-check-label" for="importAppend2">
                            Zu Liste hinzuf√ºgen
                          </label>
                        </div>
                        <div class="form-check mb-2">
                          <input
                            class="form-check-input"
                            type="radio"
                            name="importMode"
                            id="importReplace2"
                            value="replace"
                          />
                          <label class="form-check-label" for="importReplace2">
                            Liste ersetzen
                          </label>
                        </div>
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            id="skipDuplicates2"
                            checked
                          />
                          <label class="form-check-label" for="skipDuplicates2">
                            Duplikate √ºberspringen
                          </label>
                        </div>
                      </div>

                      <button
                        type="button"
                        class="btn btn-success-custom btn-custom final-final-touch w-100"
                        onclick="processBulkImport()"
                        id="bulkImportBtn2"
                      >
                        <i class="fas fa-upload"></i>&nbsp;Verben importieren
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="card fade-in-up">
                <div class="card-header bg-secondary text-white">
                  <strong><i class="fas fa-list"></i>&nbsp;Verbliste</strong>
                  <span class="badge bg-light text-dark" id="verbCount">0</span>
                </div>
                <div
                  class="card-body"
                  style="max-height: 400px; overflow-y: auto"
                >
                  <div class="mb-3">
                    <input
                      type="text"
                      id="verbSearchInput"
                      class="form-control"
                      placeholder="üîç Verben durchsuchen..."
                      oninput="filterVerbList()"
                    />
                  </div>
                  <div class="mb-2 d-flex gap-2">
                    <button
                      class="btn btn-sm btn-outline-primary"
                      onclick="sortVerbList('alphabetical')"
                      title="Alphabetisch sortieren"
                    >
                      <i class="fas fa-sort-alpha-down"></i>&nbsp;Sortieren
                    </button>
                    <button
                      class="btn btn-sm btn-outline-secondary"
                      onclick="toggleFavoriteView()"
                      id="favoriteViewBtn"
                      title="Favoriten anzeigen"
                    >
                      <i class="far fa-star"></i>&nbsp;Favoriten
                    </button>
                  </div>
                  <div id="verbList"></div>
                  <div class="text-center mt-4">
                    <button
                      class="btn btn-outline-danger btn-sm m-1 final-final-touch"
                      onclick="clearAllVerbs()"
                    >
                      <i class="fas fa-trash"></i>&nbsp;Alle L√∂schen
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <section class="col-lg-8">
              <div class="card mb-4 fade-in-up">
                <div class="card-header bg-info text-white">
                  <strong
                    ><i class="fas fa-cog"></i
                    >&nbsp;Konjugationsoptionen</strong
                  >
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <label class="mb-3">Zeiten Ausw√§hlen:</label>
                      <div class="space-y-2">
                        <label class="form-check">
                          <input
                            type="checkbox"
                            id="indikativ"
                            class="form-check-input"
                            checked
                          />
                          <span class="form-check-label notranslate"
                            >Indikativ</span
                          >
                        </label>
                        <label class="form-check">
                          <input
                            type="checkbox"
                            id="konj1"
                            class="form-check-input"
                          />
                          <span class="form-check-label notranslate"
                            >Konjunktiv I</span
                          >
                        </label>
                        <label class="form-check">
                          <input
                            type="checkbox"
                            id="konj2"
                            class="form-check-input"
                          />
                          <span class="form-check-label notranslate"
                            >Konjunktiv II</span
                          >
                        </label>
                        <label class="form-check">
                          <input
                            type="checkbox"
                            id="meaning"
                            class="form-check-input"
                            checked
                          />
                          <span class="form-check-label">Bedeutung</span>
                        </label>
                      </div>
                    </div>
                  </div>

                  <div class="row mt-4">
                    <div class="col-md-6 mb-3">
                      <button
                        class="btn btn-success-custom btn-custom final-final-touch w-100"
                        onclick="conjugateAllVerbs()"
                      >
                        <i class="fas fa-sync-alt"></i>&nbsp;Alle Konjugieren
                      </button>
                    </div>
                    <div class="col-md-6">
                      <div class="d-grid gap-2">
                        <button
                          class="btn btn-outline-primary btn-custom final-final-touch"
                          onclick="exportAsText()"
                        >
                          <i class="fas fa-file-alt"></i>&nbsp;Als Text
                        </button>
                        <button
                          class="btn btn-outline-success btn-custom final-final-touch"
                          onclick="exportAsExcel()"
                        >
                          <i class="fas fa-file-excel"></i>&nbsp;Als Excel
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="loading" id="loadingSpinner">
                <div
                  class="spinner-border animate-spin-slow"
                  role="status"
                ></div>
                <p class="mb-0 mt-3">Verben werden konjugiert...</p>
                <div class="progress mt-3" style="width: 200px; margin: 0 auto">
                  <div
                    class="progress-bar"
                    role="progressbar"
                    style="width: 0%"
                  ></div>
                </div>
                <small class="text-muted mt-2">0%</small>
              </div>

              <div id="conjugationCardsContainer" class="d-block"></div>
            </section>
          </div>
        </div>

        <div
          class="tab-pane fade"
          id="grammar-pane"
          role="tabpanel"
          aria-labelledby="grammar-tab"
        >
          <div class="row">
            <div class="col-12">
              <div class="card mb-4 fade-in-up">
                <div class="card-header bg-gradient-primary text-white">
                  <strong
                    ><i class="fas fa-spell-check"></i
                    >&nbsp;Grammatikpr√ºfung</strong
                  >
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label for="grammarTextInput" class="form-label"
                      >Text eingeben</label
                    >
                    <textarea
                      id="grammarTextInput"
                      class="form-control optimize-legibility notranslate"
                      rows="10"
                      placeholder="Geben Sie hier Ihren deutschen Text ein, um Grammatikfehler zu finden..."
                    ></textarea>
                    <div class="form-text d-flex justify-content-between mt-2">
                      <span id="textStats">0 Zeichen, 0 W√∂rter</span>
                      <button
                        class="btn btn-sm btn-outline-secondary"
                        onclick="loadExampleText()"
                      >
                        <i class="fas fa-lightbulb"></i>&nbsp;Beispieltext laden
                      </button>
                    </div>
                  </div>
                  <div class="d-flex gap-2 mb-3">
                    <button
                      class="btn btn-primary-custom btn-custom final-final-touch"
                      onclick="checkGrammarText()"
                      id="checkGrammarBtn"
                    >
                      <i class="fas fa-check-circle"></i>&nbsp;Pr√ºfen
                    </button>
                    <button
                      class="btn btn-outline-secondary btn-custom final-final-touch"
                      onclick="clearGrammarText()"
                    >
                      <i class="fas fa-eraser"></i>&nbsp;L√∂schen
                    </button>
                    <button
                      class="btn btn-outline-info btn-custom final-final-touch"
                      onclick="speakGrammarText()"
                      title="Text vorlesen"
                    >
                      <i class="fas fa-volume-up"></i>&nbsp;Vorlesen
                    </button>
                    <button
                      class="btn btn-outline-success btn-custom final-final-touch"
                      onclick="copyCorrectedText()"
                      id="copyCorrectedBtn"
                      style="display: none"
                      title="Kopiert den aktuellen Text aus dem Eingabefeld"
                    >
                      <i class="fas fa-copy"></i>&nbsp;Text kopieren
                    </button>
                  </div>

                  <div
                    id="grammarLoading"
                    class="loading"
                    style="display: none"
                  >
                    <div
                      class="spinner-border animate-spin-slow"
                      role="status"
                    ></div>
                    <p class="mb-0 mt-3">Text wird gepr√ºft...</p>
                  </div>

                  <div id="grammarResults" style="display: none">
                    <div class="alert alert-info mb-3">
                      <strong id="errorCount">0 Fehler gefunden</strong>
                    </div>

                    <div class="card mb-3">
                      <div
                        class="card-header bg-secondary text-white d-flex justify-content-between align-items-center"
                      >
                        <strong>Text mit Markierungen</strong>
                        <button
                          class="btn btn-sm btn-outline-light"
                          onclick="speakHighlightedText()"
                          title="Markierten Text vorlesen"
                        >
                          <i class="fas fa-volume-up"></i>&nbsp;Vorlesen
                        </button>
                      </div>
                      <div class="card-body">
                        <div
                          id="highlightedText"
                          class="grammar-highlighted-text notranslate"
                        ></div>
                      </div>
                    </div>

                    <div class="card">
                      <div class="card-header bg-info text-white">
                        <strong>Fehlerdetails und Vorschl√§ge</strong>
                      </div>
                      <div class="card-body">
                        <div id="errorList"></div>
                      </div>
                    </div>
                  </div>

                  <div class="card mt-4">
                    <div class="card-header bg-primary text-white">
                      <strong
                        ><i class="fas fa-chart-line"></i
                        >&nbsp;Textanalyse</strong
                      >
                    </div>
                    <div class="card-body">
                      <div class="mb-3">
                        <button
                          class="btn btn-primary-custom btn-custom final-final-touch"
                          onclick="analyzeText()"
                          id="analyzeBtn"
                        >
                          <i class="fas fa-chart-bar"></i>&nbsp;Text analysieren
                        </button>
                        <button
                          class="btn btn-outline-secondary btn-custom final-final-touch"
                          onclick="clearAnalysisText()"
                        >
                          <i class="fas fa-eraser"></i>&nbsp;Zur√ºcksetzen
                        </button>
                      </div>

                      <div id="analysisResults" style="display: none">
                        <div class="row">
                          <div class="col-md-6 mb-3">
                            <div class="card">
                              <div class="card-header bg-info text-white">
                                <strong>Lesbarkeit</strong>
                              </div>
                              <div class="card-body">
                                <div id="readabilityScore"></div>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-6 mb-3">
                            <div class="card">
                              <div class="card-header bg-success text-white">
                                <strong>Statistiken</strong>
                              </div>
                              <div class="card-body">
                                <div id="textStatistics"></div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="card mb-3">
                          <div class="card-header bg-warning text-white">
                            <strong>H√§ufigste W√∂rter</strong>
                          </div>
                          <div class="card-body">
                            <div id="wordFrequency"></div>
                          </div>
                        </div>
                        <div class="card">
                          <div class="card-header bg-primary text-white">
                            <strong>Lernvorschl√§ge</strong>
                          </div>
                          <div class="card-body">
                            <div id="learningSuggestions"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div
          class="tab-pane fade"
          id="vocabulary-pane"
          role="tabpanel"
          aria-labelledby="vocabulary-tab"
        >
          <div class="row">
            <div class="col-lg-4 mb-4">
              <div class="card mb-4 fade-in-up">
                <div class="card-header bg-gradient-primary text-white">
                  <strong><i class="fas fa-list"></i>&nbsp;Vokabelliste</strong>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label for="vocabWordInput" class="form-label"
                      >Deutsches Wort</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="vocabWordInput"
                      placeholder="z.B. gehen"
                    />
                  </div>
                  <div class="mb-3">
                    <label for="vocabTranslationInput" class="form-label"
                      >√úbersetzung (optional)</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="vocabTranslationInput"
                      placeholder="z.B. to go"
                    />
                  </div>
                  <div class="mb-3">
                    <label for="vocabNotesInput" class="form-label"
                      >Notizen (optional)</label
                    >
                    <textarea
                      class="form-control"
                      id="vocabNotesInput"
                      rows="2"
                      placeholder="Zus√§tzliche Informationen..."
                    ></textarea>
                  </div>
                  <button
                    class="btn btn-primary-custom w-100 mb-3"
                    onclick="addVocabularyWord()"
                  >
                    <i class="fas fa-plus"></i>&nbsp;Wort hinzuf√ºgen
                  </button>
                  <button
                    class="btn btn-outline-info w-100 mb-3"
                    onclick="importFromGrammarCheck()"
                  >
                    <i class="fas fa-download"></i>&nbsp;Aus Textanalyse
                    importieren
                  </button>

                  <div class="mb-3">
                    <input
                      type="text"
                      class="form-control"
                      id="vocabSearchInput"
                      placeholder="Vokabeln durchsuchen..."
                      oninput="filterVocabularyList()"
                    />
                  </div>

                  <div class="card mb-3">
                    <div class="card-body p-2">
                      <div class="row text-center">
                        <div class="col-6 mb-2">
                          <div class="statistics-card">
                            <div class="h5 mb-0" id="vocabTotalCount">0</div>
                            <small class="text-muted">Gesamt</small>
                          </div>
                        </div>
                        <div class="col-6 mb-2">
                          <div class="statistics-card">
                            <div class="h5 mb-0" id="vocabDueCount">0</div>
                            <small class="text-muted">F√§llig</small>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="statistics-card">
                            <div class="h5 mb-0" id="vocabMasteredCount">0</div>
                            <small class="text-muted">Gelernt</small>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="statistics-card">
                            <div class="h5 mb-0" id="vocabNewCount">0</div>
                            <small class="text-muted">Neu</small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div
                    id="vocabularyList"
                    style="max-height: 400px; overflow-y: auto"
                  ></div>
                </div>
              </div>
            </div>

            <div class="col-lg-8 mb-4">
              <div class="card mb-4 fade-in-up">
                <div class="card-header bg-gradient-success text-white">
                  <strong><i class="fas fa-book-reader"></i>&nbsp;√úbung</strong>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label class="form-label">√úbungsmodus</label>
                    <select class="form-select" id="practiceModeSelect">
                      <option value="due">Nur f√§llige W√∂rter</option>
                      <option value="all">Alle W√∂rter</option>
                      <option value="new">Nur neue W√∂rter</option>
                      <option value="learning">W√∂rter in Lernphase</option>
                    </select>
                  </div>

                  <button
                    class="btn btn-success-custom w-100 mb-3"
                    id="startPracticeBtn"
                    onclick="startPracticeSession()"
                  >
                    <i class="fas fa-play"></i>&nbsp;√úbung starten
                  </button>

                  <div id="practiceSession" style="display: none">
                    <div class="progress-indicator mb-3">
                      <div class="d-flex justify-content-between mb-2">
                        <span
                          >Karte <span id="currentCardNum">1</span> von
                          <span id="totalCardsNum">0</span></span
                        >
                        <button
                          class="btn btn-sm btn-outline-danger"
                          onclick="endSession()"
                        >
                          <i class="fas fa-stop"></i>&nbsp;Beenden
                        </button>
                      </div>
                      <div class="progress">
                        <div
                          class="progress-bar bg-success"
                          id="practiceProgressBar"
                          role="progressbar"
                          style="width: 0%"
                        ></div>
                      </div>
                    </div>

                    <div class="vocabulary-card-container mb-3">
                      <div
                        class="vocabulary-card"
                        id="flashcard"
                        onclick="flipCard()"
                      >
                        <div class="card-front">
                          <div class="card-content">
                            <i
                              class="fas fa-volume-up float-end text-muted"
                              style="cursor: pointer"
                              onclick="event.stopPropagation(); speakVocabularyWord()"
                            ></i>
                            <h3 class="mb-0" id="flashcardWord">Wort</h3>
                            <p class="text-muted mt-2">
                              <small>Klicken zum Umdrehen</small>
                            </p>
                          </div>
                        </div>
                        <div class="card-back">
                          <div class="card-content">
                            <h4 class="mb-2" id="flashcardTranslation">
                              √úbersetzung
                            </h4>
                            <p class="text-muted" id="flashcardNotes"></p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="difficulty-buttons">
                      <div class="row g-2">
                        <div class="col-6 col-md-3">
                          <button
                            class="btn btn-danger w-100"
                            onclick="handleDifficulty(0)"
                            title="Wiederholen (Taste: 1)"
                          >
                            <i class="fas fa-redo"></i><br />Wiederholen
                          </button>
                        </div>
                        <div class="col-6 col-md-3">
                          <button
                            class="btn btn-warning w-100"
                            onclick="handleDifficulty(1)"
                            title="Schwer (Taste: 2)"
                          >
                            <i class="fas fa-exclamation-triangle"></i
                            ><br />Schwer
                          </button>
                        </div>
                        <div class="col-6 col-md-3">
                          <button
                            class="btn btn-info w-100"
                            onclick="handleDifficulty(2)"
                            title="Mittel (Taste: 3)"
                          >
                            <i class="fas fa-check"></i><br />Mittel
                          </button>
                        </div>
                        <div class="col-6 col-md-3">
                          <button
                            class="btn btn-success w-100"
                            onclick="handleDifficulty(3)"
                            title="Einfach (Taste: 4)"
                          >
                            <i class="fas fa-check-circle"></i><br />Einfach
                          </button>
                        </div>
                      </div>
                    </div>

                    <div class="mt-3">
                      <div class="card">
                        <div class="card-body p-2">
                          <div class="row text-center">
                            <div class="col-4">
                              <div class="h6 mb-0" id="sessionCorrect">0</div>
                              <small class="text-muted">Richtig</small>
                            </div>
                            <div class="col-4">
                              <div class="h6 mb-0" id="sessionIncorrect">0</div>
                              <small class="text-muted">Falsch</small>
                            </div>
                            <div class="col-4">
                              <div class="h6 mb-0" id="sessionReviewed">0</div>
                              <small class="text-muted">Wiederholt</small>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="card mt-3">
                    <div class="card-header bg-info text-white">
                      <strong
                        ><i class="fas fa-clock"></i>&nbsp;Warteschlange</strong
                      >
                    </div>
                    <div class="card-body">
                      <div
                        id="reviewQueue"
                        style="max-height: 200px; overflow-y: auto"
                      ></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div class="modal fade" id="bulkUploadHelpModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-question-circle"></i>&nbsp;Bulk Upload Hilfe
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <h6 class="text-primary mb-3">
              <i class="fas fa-file-text"></i>&nbsp;TXT Datei oder Text einf√ºgen
            </h6>
            <p>
              Wenn Sie eine TXT-Datei hochladen oder Text einf√ºgen, durchsucht
              die Website automatisch den gesamten Text nach W√∂rtern und f√ºgt
              alle gefundenen W√∂rter zur Verbliste hinzu.
            </p>
            <p class="mb-4">
              <strong>Beispiel:</strong> Der Text "Ich gehe heute in die Schule
              und lerne Deutsch" w√ºrde die W√∂rter "gehe", "lerne" erkennen und
              hinzuf√ºgen.
            </p>

            <h6 class="text-primary mb-3">
              <i class="fas fa-file-excel"></i>&nbsp;XLSX Datei
            </h6>
            <p>
              Wenn Sie eine Excel-Datei (XLSX) hochladen, erwartet die Website
              folgendes Format:
            </p>
            <ul>
              <li><strong>Spalte A:</strong> Deutsche Verben (erforderlich)</li>
              <li>
                <strong>Spalte B:</strong> T√ºrkische Bedeutungen (optional)
              </li>
            </ul>
            <div class="alert alert-info mt-3">
              <strong>Hinweis:</strong> Die erste Zeile kann √úberschriften
              enthalten und wird automatisch √ºbersprungen.
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="helpModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-question-circle"></i>&nbsp;Bedienungsanleitung
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <ol class="enhanced-spacing">
              <li>
                <strong>Verb Hinzuf√ºgen:</strong> Geben Sie ein deutsches Verb
                im Infinitiv ein.
              </li>
              <li>
                <strong>T√ºrkische Bedeutung:</strong> Optional hinzuf√ºgen.
              </li>
              <li>
                <strong>Zeiten Ausw√§hlen:</strong> Gew√ºnschte Zeitformen w√§hlen.
              </li>
              <li>
                <strong>Konjugieren:</strong> Klicken Sie auf "Alle konjugieren"
                oder dr√ºcken Sie STRG+Eingabe.
              </li>
              <li><strong>Export:</strong> Als Text oder Excel exportieren.</li>
            </ol>
            <hr class="my-4" />
            <h6 class="text-gradient">Unterst√ºtzte Zeitformen:</h6>
            <ul class="list-unstyled notranslate">
              <li>
                <i class="fas fa-check-circle text-primary me-2"></i
                ><strong>Pr√§sens</strong>
              </li>
              <li>
                <i class="fas fa-check-circle text-primary me-2"></i
                ><strong>Perfekt</strong>
              </li>
              <li>
                <i class="fas fa-check-circle text-primary me-2"></i
                ><strong>Pr√§teritum</strong>
              </li>
              <li>
                <i class="fas fa-check-circle text-primary me-2"></i
                ><strong>Plusquamperfekt</strong>
              </li>
              <li>
                <i class="fas fa-check-circle text-primary me-2"></i
                ><strong>Futur I</strong>
              </li>
              <li>
                <i class="fas fa-check-circle text-primary me-2"></i
                ><strong>Futur II</strong>
              </li>
              <li>
                <i class="fas fa-check-circle text-primary me-2"></i
                ><strong>Konjunktiv I</strong>
              </li>
              <li>
                <i class="fas fa-check-circle text-primary me-2"></i
                ><strong>Konjunktiv II</strong>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <div class="gtranslate_wrapper"></div>
    <script>
      window.gtranslateSettings = {
        default_language: "de",
        native_language_names: true,
        languages: ["de", "tr", "en"],
        wrapper_selector: ".gtranslate_wrapper",
        switcher_horizontal_position: "right",
        alt_flags: { en: "usa" },
      };
    </script>
    <script
      src="https://cdn.gtranslate.net/widgets/latest/float.js"
      defer
    ></script>

    <script>
      let verbList = [];
      let conjugationData = {};
      let exportInProgress = false;

      const PRONOUNS = ["ich", "du", "er/sie/es", "wir", "ihr", "sie/Sie"];
      const CONJUGATION_META = {
        PRASENS: { label: "Pr√§sens", mood: "Indikativ" },
        PRATERITUM: { label: "Pr√§teritum", mood: "Indikativ" },
        PERFEKT: { label: "Perfekt", mood: "Indikativ" },
        PLUSQUAMPERFEKT: { label: "Plusquamperfekt", mood: "Indikativ" },
        FUTUR1: { label: "Futur I", mood: "Indikativ" },
        FUTUR2: { label: "Futur II", mood: "Indikativ" },
        KONJUNKTIV1_PRASENS: { label: "Pr√§sens", mood: "Konjunktiv I" },
        KONJUNKTIV1_FUTUR1: { label: "Futur I", mood: "Konjunktiv I" },
        KONJUNKTIV1_PERFEKT: { label: "Perfekt", mood: "Konjunktiv I" },
        KONJUNKTIV2_PRATERITUM: { label: "Pr√§teritum", mood: "Konjunktiv II" },
        KONJUNKTIV2_FUTUR1: { label: "Futur I", mood: "Konjunktiv II" },
        KONJUNKTIV2_FUTUR2: { label: "Futur II", mood: "Konjunktiv II" },
      };

      document.addEventListener("DOMContentLoaded", function () {
        initializeParticles();
        initializeTheme();
        clearExpiredCache();
        loadFromLocalStorage();
        updateVerbList();
        addKeyboardShortcuts();
        restoreActiveTab();
        warmUpSpeechSynthesis();
      });

      function initializeParticles() {
        const particleContainer = document.querySelector(".particle-system");
        if (!particleContainer) return;

        for (let i = 0; i < 50; i++) {
          const particle = document.createElement("div");
          particle.className = "particle";
          particle.style.left = Math.random() * 100 + "%";
          particle.style.animationDelay = Math.random() * 25 + "s";
          particle.style.animationDuration = Math.random() * 10 + 15 + "s";
          particleContainer.appendChild(particle);
        }
      }

      function initializeTheme() {
        const themeToggle = document.getElementById("themeToggle");
        if (!themeToggle) return;

        const toggleContainer = themeToggle.closest(
          ".dark-mode-toggle-final-final-enhanced"
        );
        if (!toggleContainer) return;

        const stored = localStorage.getItem("theme");
        const prefersDark =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;
        const dark = stored ? stored === "dark" : prefersDark;

        applyTheme(dark ? "dark" : "light");
        themeToggle.checked = dark;
        updateToggleVisuals(themeToggle, toggleContainer);

        themeToggle.addEventListener("change", function () {
          const mode = this.checked ? "dark" : "light";
          applyTheme(mode);
          localStorage.setItem("theme", mode);
          updateToggleVisuals(this, toggleContainer);
        });

        window
          .matchMedia("(prefers-color-scheme: dark)")
          .addEventListener("change", (e) => {
            if (!localStorage.getItem("theme")) {
              applyTheme(e.matches ? "dark" : "light");
              themeToggle.checked = e.matches;
              updateToggleVisuals(themeToggle, toggleContainer);
            }
          });
      }

      function updateToggleVisuals(toggle, container) {
        if (!container) return;
        if (toggle.checked) {
          container.classList.add("toggle-checked");
        } else {
          container.classList.remove("toggle-checked");
        }
      }

      function applyTheme(name) {
        if (name === "dark") {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }
      }

      function showAlert(msg, type = "info") {
        const alertDiv = document.createElement("div");
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
            <span style="flex: 1; min-width: 0; word-wrap: break-word; overflow-wrap: break-word; padding-right: 8px;">
              ${msg}
              <span style="padding: 6px;">
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close" style="opacity: 1;"></button>
              </span>
            </span>
          </div>
        `;

        const colors = {
          info: "#3b82f6",
          success: "#10b981",
          warning: "#f59e0b",
          danger: "#ef4444",
        };

        alertDiv.style.cssText = `
          position: fixed;
          top: 20px;
          left: 50%;
          z-index: 2000;
          background: linear-gradient(135deg, ${colors[type]} 0%, ${colors[type]}dd 100%);
          color: white;
          border: none;
          border-radius: 12px;
          padding: 16px 24px;
          font-weight: 500;
          box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
          min-width: 300px;
          max-width: 90vw;
          transform: translateX(-50%);
          animation: slideInDownCentered 0.3s ease-out;
        `;

        document.body.appendChild(alertDiv);

        setTimeout(() => {
          alertDiv.remove();
        }, 5000);
      }

      function showLoading(show) {
        const loading = document.getElementById("loadingSpinner");
        if (!loading) return;

        loading.style.display = show ? "block" : "none";

        if (show) {
          const progressBar = loading.querySelector(".progress-bar");
          const progressText = loading.querySelector("small");
          if (progressBar) progressBar.style.width = "0%";
          if (progressText) progressText.textContent = "0%";
        }
      }

      function updateProgress(current, total) {
        const loading = document.getElementById("loadingSpinner");
        if (!loading) return;

        const progressBar = loading.querySelector(".progress-bar");
        const progressText = loading.querySelector("small");

        if (progressBar && progressText) {
          const progress = Math.round((current / total) * 100);
          progressBar.style.width = progress + "%";
          progressBar.textContent = progress + "%";
          progressText.textContent = `${current} von ${total} Verben konjugiert`;
        }
      }

      function saveToLocalStorage() {
        localStorage.setItem("verbList", JSON.stringify(verbList));
      }

      function loadFromLocalStorage() {
        const saved = localStorage.getItem("verbList");
        if (saved) {
          verbList = JSON.parse(saved);
        }
      }

      function saveToCache(key, data) {
        const cacheData = {
          data: data,
          timestamp: Date.now(),
          expires: Date.now() + 24 * 60 * 60 * 1000,
        };
        localStorage.setItem(key, JSON.stringify(cacheData));
      }

      function getFromCache(key) {
        const cached = localStorage.getItem(key);
        if (!cached) return null;

        try {
          const parsed = JSON.parse(cached);
          if (parsed.expires && parsed.expires < Date.now()) {
            localStorage.removeItem(key);
            return null;
          }
          return parsed.data;
        } catch (e) {
          return null;
        }
      }

      function clearExpiredCache() {
        const keys = Object.keys(localStorage);
        const now = Date.now();
        let cleared = 0;

        keys.forEach((key) => {
          if (key.startsWith("conj_")) {
            try {
              const cached = localStorage.getItem(key);
              if (cached) {
                const parsed = JSON.parse(cached);
                if (parsed.expires && parsed.expires < now) {
                  localStorage.removeItem(key);
                  cleared++;
                }
              }
            } catch (e) {
              localStorage.removeItem(key);
              cleared++;
            }
          }
        });

        if (cleared > 0) {
          console.log(`Cleared ${cleared} expired cache entries`);
        }
      }

      const verbFormEl = document.getElementById("verbForm");
      if (verbFormEl) {
        verbFormEl.addEventListener("submit", function (e) {
          e.preventDefault();
          addVerb();
        });
      }

      function addVerb() {
        const verbInput = document.getElementById("verbInput");
        const turkishInput = document.getElementById("turkishMeaning");

        const verb = verbInput?.value.trim().toLowerCase() || "";
        const turkish = turkishInput?.value.trim() || "";

        if (!verb) {
          showAlert("Bitte geben Sie ein Verb ein!", "warning");
          return;
        }

        if (verbList.some((v) => v.verb === verb)) {
          showAlert("Dieses Verb existiert bereits!", "warning");
          return;
        }

        verbList.push({
          verb: verb,
          turkish: turkish,
          id: Date.now(),
        });

        verbInput.value = "";
        turkishInput.value = "";

        updateVerbList();
        saveToLocalStorage();
        showAlert("Verb erfolgreich hinzugef√ºgt!", "success");
      }

      function updateVerbList() {
        const container = document.getElementById("verbList");
        const count = document.getElementById("verbCount");

        count.textContent = verbList.length;

        if (verbList.length === 0) {
          container.innerHTML =
            '<p class="text-muted text-center">Keine Verben vorhanden</p>';
          return;
        }

        const favorites = JSON.parse(
          localStorage.getItem("favoriteVerbs") || "[]"
        );
        const showFavoritesOnly =
          document
            .getElementById("favoriteViewBtn")
            ?.classList.contains("active") || false;

        let filteredList = verbList;
        if (showFavoritesOnly) {
          filteredList = verbList.filter((v) => favorites.includes(v.verb));
        }

        const searchTerm = (
          document.getElementById("verbSearchInput")?.value || ""
        ).toLowerCase();
        if (searchTerm) {
          filteredList = filteredList.filter(
            (v) =>
              v.verb.toLowerCase().includes(searchTerm) ||
              (v.turkish && v.turkish.toLowerCase().includes(searchTerm))
          );
        }

        if (filteredList.length === 0) {
          container.innerHTML =
            '<p class="text-muted text-center">Keine Verben gefunden</p>';
          return;
        }

        container.innerHTML = filteredList
          .map((item) => {
            const isFavorite = favorites.includes(item.verb);
            return `
          <div class="verb-item final-final-touch" data-verb="${escapeHtml(
            item.verb
          )}">
            <div>
              <button
                class="btn btn-link p-1 me-2 favorite-star-btn"
                onclick="toggleVerbFavorite('${escapeHtml(item.verb)}')"
                title="${
                  isFavorite
                    ? "Aus Favoriten entfernen"
                    : "Zu Favoriten hinzuf√ºgen"
                }"
              >
                <i class="${
                  isFavorite ? "fas" : "far"
                } fa-star text-warning"></i>
              </button>
              <strong class="notranslate">${escapeHtml(item.verb)}</strong>
              ${
                item.turkish
                  ? `<small class="text-muted notranslate">(${escapeHtml(
                      item.turkish
                    )})</small>`
                  : ""
              }
            </div>
            <div>
              <span class="me-2">
                <button class="btn btn-sm btn-outline-secondary move-up final-final-touch" onclick="moveUpVerb('${escapeHtml(
                  item.verb
                )}')">
                  <i class="fas fa-chevron-up"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary move-down final-final-touch" onclick="moveDownVerb('${escapeHtml(
                  item.verb
                )}')">
                  <i class="fas fa-chevron-down"></i>
                </button>
              </span>
              <button class="btn btn-sm btn-outline-danger final-final-touch" onclick="removeVerb(${
                item.id
              })">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        `;
          })
          .join("");
      }

      function filterVerbList() {
        updateVerbList();
      }

      function sortVerbList(mode) {
        if (mode === "alphabetical") {
          verbList.sort((a, b) => a.verb.localeCompare(b.verb));
          updateVerbList();
          saveToLocalStorage();
          showAlert("Verbliste alphabetisch sortiert!", "success");
        }
      }

      function toggleVerbFavorite(verb) {
        let favorites = JSON.parse(
          localStorage.getItem("favoriteVerbs") || "[]"
        );
        const index = favorites.indexOf(verb);
        if (index > -1) {
          favorites.splice(index, 1);
          showAlert(
            `<span class="notranslate">"${verb}"</span> aus Favoriten entfernt`,
            "info"
          );
        } else {
          favorites.push(verb);
          showAlert(
            `<span class="notranslate">"${verb}"</span> zu Favoriten hinzugef√ºgt`,
            "success"
          );
        }
        localStorage.setItem("favoriteVerbs", JSON.stringify(favorites));
        updateVerbList();
      }

      function toggleFavoriteView() {
        const btn = document.getElementById("favoriteViewBtn");
        btn.classList.toggle("active");
        if (btn.classList.contains("active")) {
          btn.innerHTML = '<i class="fas fa-star"></i>&nbsp;Alle';
        } else {
          btn.innerHTML = '<i class="far fa-star"></i>&nbsp;Favoriten';
        }
        updateVerbList();
      }

      function moveUpVerb(verb) {
        const favorites = JSON.parse(
          localStorage.getItem("favoriteVerbs") || "[]"
        );
        const showFavoritesOnly =
          document
            .getElementById("favoriteViewBtn")
            ?.classList.contains("active") || false;

        let filteredList = verbList;
        if (showFavoritesOnly) {
          filteredList = verbList.filter((v) => favorites.includes(v.verb));
        }

        const searchTerm = (
          document.getElementById("verbSearchInput")?.value || ""
        ).toLowerCase();
        if (searchTerm) {
          filteredList = filteredList.filter(
            (v) =>
              v.verb.toLowerCase().includes(searchTerm) ||
              (v.turkish && v.turkish.toLowerCase().includes(searchTerm))
          );
        }

        const filteredIndex = filteredList.findIndex((v) => v.verb === verb);
        if (filteredIndex <= 0) return;

        const verbAbove = filteredList[filteredIndex - 1];

        const currentIndex = verbList.findIndex((v) => v.verb === verb);
        const aboveIndex = verbList.findIndex((v) => v.verb === verbAbove.verb);

        if (currentIndex !== -1 && aboveIndex !== -1) {
          [verbList[aboveIndex], verbList[currentIndex]] = [
            verbList[currentIndex],
            verbList[aboveIndex],
          ];
          updateVerbList();
          saveToLocalStorage();
        }
      }

      function moveDownVerb(verb) {
        const favorites = JSON.parse(
          localStorage.getItem("favoriteVerbs") || "[]"
        );
        const showFavoritesOnly =
          document
            .getElementById("favoriteViewBtn")
            ?.classList.contains("active") || false;

        let filteredList = verbList;
        if (showFavoritesOnly) {
          filteredList = verbList.filter((v) => favorites.includes(v.verb));
        }

        const searchTerm = (
          document.getElementById("verbSearchInput")?.value || ""
        ).toLowerCase();
        if (searchTerm) {
          filteredList = filteredList.filter(
            (v) =>
              v.verb.toLowerCase().includes(searchTerm) ||
              (v.turkish && v.turkish.toLowerCase().includes(searchTerm))
          );
        }

        const filteredIndex = filteredList.findIndex((v) => v.verb === verb);
        if (filteredIndex === -1 || filteredIndex >= filteredList.length - 1)
          return;

        const verbBelow = filteredList[filteredIndex + 1];

        const currentIndex = verbList.findIndex((v) => v.verb === verb);
        const belowIndex = verbList.findIndex((v) => v.verb === verbBelow.verb);

        if (currentIndex !== -1 && belowIndex !== -1) {
          [verbList[currentIndex], verbList[belowIndex]] = [
            verbList[belowIndex],
            verbList[currentIndex],
          ];
          updateVerbList();
          saveToLocalStorage();
        }
      }

      function removeVerb(id) {
        verbList = verbList.filter((v) => v.id !== id);
        updateVerbList();
        saveToLocalStorage();
        showAlert("Verb entfernt!", "info");
      }

      function clearAllVerbs() {
        if (!confirm("M√∂chten Sie wirklich alle Verben l√∂schen?")) return;
        verbList = [];
        conjugationData = {};
        updateVerbList();
        document.getElementById("conjugationCardsContainer").innerHTML = "";
        saveToLocalStorage();
        showAlert("Alle Verben wurden gel√∂scht!", "info");
      }

      function sortAllVerbs() {
        verbList.sort((a, b) => a.verb.localeCompare(b.verb));
        updateVerbList();
        saveToLocalStorage();
        showAlert("Verben alphabetisch sortiert!", "success");
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }

      function parseTextForVerbs(text) {
        const wordRegex = /\b[a-z√§√∂√º√ü]+\b/gi;
        const matches = text.match(wordRegex) || [];

        const uniqueWords = [...new Set(matches.map((w) => w.toLowerCase()))];

        const commonWords = [
          "der",
          "die",
          "das",
          "ein",
          "eine",
          "und",
          "oder",
          "aber",
          "ist",
          "sind",
          "war",
          "waren",
        ];
        const verbs = uniqueWords.filter(
          (word) => word.length > 2 && !commonWords.includes(word)
        );

        return verbs.map((verb) => ({ verb, turkish: "" }));
      }

      async function parseUploadedFile(file) {
        return new Promise((resolve, reject) => {
          const fileName = file.name.toLowerCase();
          const fileExtension = fileName.split(".").pop();

          if (fileExtension === "txt") {
            const reader = new FileReader();
            reader.onload = function (e) {
              try {
                const text = e.target.result;
                const verbs = parseTextForVerbs(text);
                resolve(verbs);
              } catch (error) {
                reject(
                  new Error("Fehler beim Lesen der TXT-Datei: " + error.message)
                );
              }
            };
            reader.onerror = () =>
              reject(new Error("Fehler beim Lesen der Datei"));
            reader.readAsText(file, "UTF-8");
          } else if (fileExtension === "xlsx") {
            const reader = new FileReader();
            reader.onload = function (e) {
              try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                  header: 1,
                  defval: "",
                });

                const verbs = [];

                const startRow =
                  jsonData.length > 0 &&
                  typeof jsonData[0][0] === "string" &&
                  (jsonData[0][0].toLowerCase().includes("verb") ||
                    jsonData[0][0].toLowerCase().includes("wort"))
                    ? 1
                    : 0;

                for (let i = startRow; i < jsonData.length; i++) {
                  const row = jsonData[i];
                  const verb = String(row[0] || "")
                    .trim()
                    .toLowerCase();
                  const turkish = String(row[1] || "").trim();

                  if (verb && /^[a-z√§√∂√º√ü]+$/.test(verb)) {
                    verbs.push({ verb, turkish });
                  }
                }

                resolve(verbs);
              } catch (error) {
                reject(
                  new Error(
                    "Fehler beim Lesen der Excel-Datei: " + error.message
                  )
                );
              }
            };
            reader.onerror = () =>
              reject(new Error("Fehler beim Lesen der Datei"));
            reader.readAsArrayBuffer(file);
          } else {
            reject(
              new Error(
                "Nicht unterst√ºtztes Dateiformat. Bitte verwenden Sie TXT oder XLSX."
              )
            );
          }
        });
      }

      async function processBulkImport() {
        const fileInput = document.getElementById("verbFileInput");
        const textInput = document.getElementById("bulkTextInput");
        const fileTab = document.getElementById("file-upload-tab");
        const textTab = document.getElementById("text-paste-tab");
        const isFileMode = fileTab.classList.contains("active");
        const isTextMode = textTab.classList.contains("active");

        const importBtn = isFileMode
          ? document.getElementById("bulkImportBtn")
          : document.getElementById("bulkImportBtn2");

        let verbs = [];

        try {
          importBtn.disabled = true;
          importBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i>&nbsp;Wird verarbeitet...';

          if (isFileMode) {
            const file = fileInput.files[0];
            if (!file) {
              showAlert("Bitte w√§hlen Sie eine Datei aus!", "warning");
              importBtn.disabled = false;
              importBtn.innerHTML =
                '<i class="fas fa-upload"></i>&nbsp;Verben importieren';
              return;
            }
            verbs = await parseUploadedFile(file);
          } else if (isTextMode) {
            const text = textInput.value.trim();
            if (!text) {
              showAlert("Bitte f√ºgen Sie Text ein!", "warning");
              importBtn.disabled = false;
              importBtn.innerHTML =
                '<i class="fas fa-upload"></i>&nbsp;Verben importieren';
              return;
            }
            verbs = parseTextForVerbs(text);
          } else {
            showAlert("Bitte w√§hlen Sie eine Import-Methode aus!", "warning");
            importBtn.disabled = false;
            importBtn.innerHTML =
              '<i class="fas fa-upload"></i>&nbsp;Verben importieren';
            return;
          }

          if (verbs.length === 0) {
            showAlert("Keine Verben gefunden!", "warning");
            importBtn.disabled = false;
            importBtn.innerHTML =
              '<i class="fas fa-upload"></i>&nbsp;Verben importieren';
            return;
          }

          const importModeRadio = document.querySelector(
            'input[name="importMode"]:checked'
          );
          const skipDuplicatesCheck =
            document.getElementById("skipDuplicates") ||
            document.getElementById("skipDuplicates2");

          const importMode = importModeRadio ? importModeRadio.value : "append";
          const skipDuplicates = skipDuplicatesCheck
            ? skipDuplicatesCheck.checked
            : true;

          importVerbs(verbs, importMode, skipDuplicates);

          fileInput.value = "";
          textInput.value = "";
        } catch (error) {
          console.error("Import error:", error);
          showAlert("Fehler beim Importieren: " + error.message, "danger");
        } finally {
          importBtn.disabled = false;
          importBtn.innerHTML =
            '<i class="fas fa-upload"></i>&nbsp;Verben importieren';
        }
      }

      function importVerbs(verbs, mode, skipDuplicates) {
        let added = 0;
        let skipped = 0;
        let invalid = 0;

        if (mode === "replace") {
          verbList = [];
        }

        verbs.forEach((item) => {
          const verb = item.verb.trim().toLowerCase();

          if (!verb || !/^[a-z√§√∂√º√ü]+$/.test(verb)) {
            invalid++;
            return;
          }

          if (skipDuplicates && verbList.some((v) => v.verb === verb)) {
            skipped++;
            return;
          }

          verbList.push({
            verb: verb,
            turkish: item.turkish || "",
            id: Date.now() + Math.random(),
          });
          added++;
        });

        updateVerbList();
        saveToLocalStorage();

        let message = `${added} Verb${
          added !== 1 ? "en" : ""
        } erfolgreich importiert!`;
        if (skipped > 0) {
          message += ` ${skipped} Duplikat${
            skipped !== 1 ? "e" : ""
          } √ºbersprungen.`;
        }
        if (invalid > 0) {
          message += ` ${invalid} ung√ºltige Eintr√§ge √ºbersprungen.`;
        }
        showAlert(message, "success");
      }

      function getSelectedVerbs() {
        return verbList.map((v) => v.verb).filter(Boolean);
      }

      function getSelectedMoods() {
        const moods = [];
        if (document.getElementById("indikativ").checked)
          moods.push("INDIKATIV");
        if (document.getElementById("konj1").checked) moods.push("KONJUNKTIV1");
        if (document.getElementById("konj2").checked) moods.push("KONJUNKTIV2");
        return moods;
      }

      function stringifyParts(parts) {
        if (Array.isArray(parts)) return parts.join(" ");
        if (typeof parts === "string") return parts;
        return parts ? String(parts) : "";
      }

      function extractSixForms(tenseObj) {
        if (!tenseObj) return ["", "", "", "", "", ""];
        if (Array.isArray(tenseObj))
          return Array.from({ length: 6 }, (_, i) =>
            stringifyParts(tenseObj[i] ?? "")
          );
        const keys = ["S1", "S2", "S3", "P1", "P2", "P3"];
        if (typeof tenseObj === "object")
          return keys.map((k) => stringifyParts(tenseObj[k] ?? ""));
        if (typeof tenseObj === "string") return [tenseObj, "", "", "", "", ""];
        return ["", "", "", "", "", ""];
      }

      async function fetchVerbFromApi(verb) {
        const key = `conj_${verb}`;
        try {
          const cached = getFromCache(key);
          if (cached) return cached;

          console.log(`Fetching verb: ${verb}`);

          const resp = await fetch(
            `https://german-verbs-api.onrender.com/german-verbs-api?verb=${encodeURIComponent(
              verb
            )}`
          );

          if (!resp.ok) throw new Error("HTTP " + resp.status);
          const data = await resp.json();

          console.log(`API Response for ${verb}:`, data);
          saveToCache(key, data);
          return data;
        } catch (e) {
          console.error("fetch error", verb, e);
          throw e;
        }
      }

      function normaliseConjugations(apiData) {
        if (!apiData || typeof apiData !== "object") return {};

        console.log("Normalizing conjugations:", apiData);
        const rawData = apiData.data || apiData;

        const MAP = {
          prasens: "PRASENS",
          prateritum: "PRATERITUM",
          perfekt: "PERFEKT",
          plusquamperfekt: "PLUSQUAMPERFEKT",
          futur1: "FUTUR1",
          futur2: "FUTUR2",
          konjunktiv1_prasens: "KONJUNKTIV1_PRASENS",
          konjunktiv1_perfekt: "KONJUNKTIV1_PERFEKT",
          konjunktiv1_futur1: "KONJUNKTIV1_FUTUR1",
          konjunktiv2_prateritum: "KONJUNKTIV2_PRATERITUM",
          konjunktiv2_futur1: "KONJUNKTIV2_FUTUR1",
          konjunktiv2_futur2: "KONJUNKTIV2_FUTUR2",
        };

        const out = {};
        Object.entries(rawData).forEach(([key, value]) => {
          const normalizedKey = MAP[key.toLowerCase()];
          if (normalizedKey && value) {
            out[normalizedKey] = value;
            console.log(`Mapped ${key} -> ${normalizedKey}:`, value);
          }
        });

        console.log("Final normalized conjugations:", out);
        return out;
      }

      async function processVerb(verb) {
        try {
          const apiResult = await fetchVerbFromApi(verb);
          const verbMap = getVerbMap();

          console.log(`Processing verb ${verb}:`, apiResult);

          conjugationData[verb] = {
            verb,
            turkish: verbMap[verb] || "",
            conjugations: normaliseConjugations(apiResult),
          };

          console.log(
            `Final conjugationData for ${verb}:`,
            conjugationData[verb]
          );
        } catch (error) {
          console.error(`Error processing verb ${verb}:`, error);
          conjugationData[verb] = {
            verb,
            turkish: "",
            conjugations: {},
          };
        }
      }

      function getVerbMap() {
        return Object.fromEntries(verbList.map((v) => [v.verb, v.turkish]));
      }

      async function conjugateAllVerbs() {
        const verbs = getSelectedVerbs();
        if (verbs.length === 0) {
          showAlert("Bitte f√ºgen Sie zuerst Verben hinzu!", "warning");
          return;
        }

        const selectedMoods = getSelectedMoods();
        if (selectedMoods.length === 0) {
          showAlert(
            "Bitte w√§hlen Sie mindestens eine Zeitform aus!",
            "warning"
          );
          return;
        }

        showLoading(true);
        document.getElementById("conjugationCardsContainer").innerHTML = "";
        conjugationData = {};

        try {
          updateProgress(0, verbs.length);

          const CONCURRENCY_LIMIT = 3;
          let processed = 0;

          for (let i = 0; i < verbs.length; i += CONCURRENCY_LIMIT) {
            const chunk = verbs.slice(i, i + CONCURRENCY_LIMIT);
            const promises = chunk.map(async (verb) => {
              try {
                await processVerb(verb);
                processed++;
                updateProgress(processed, verbs.length);
              } catch (error) {
                processed++;
                updateProgress(processed, verbs.length);
                console.error(`Fehler bei Verb ${verb}:`, error);
              }
            });

            await Promise.all(promises);
          }

          const container = document.getElementById(
            "conjugationCardsContainer"
          );
          const fragment = document.createDocumentFragment();

          verbs.forEach((verb) => {
            if (conjugationData[verb] && conjugationData[verb].conjugations) {
              const gridCard = createVerbCard(verb, selectedMoods);
              fragment.appendChild(gridCard);
            }
          });

          container.appendChild(fragment);
          showAlert("Konjugation abgeschlossen", "success");
        } catch (error) {
          console.error("Konjugationsfehler:", error);
          showAlert("Fehler bei der Konjugation", "danger");
        } finally {
          showLoading(false);
        }
      }

      async function conjugateAllVerbsIfNot() {
        const container = document.getElementById("conjugationCardsContainer");
        if (!container.innerHTML.trim()) {
          await conjugateAllVerbs();
        }
      }

      function createVerbCard(verb, selectedMoods) {
        const showTurkish = document.getElementById("meaning").checked;
        const vData = conjugationData[verb];

        const card = document.createElement("div");
        card.className = "card mobile-card mb-3 fade-in-up";

        const header = document.createElement("div");
        header.className =
          "card-header verb-header-compact bg-gradient-primary text-white";
        header.innerHTML = `
        <div class="verb-name-compact notranslate">${escapeHtml(verb)}</div>
        ${
          showTurkish && vData.turkish
            ? `<div class="verb-turkish-compact notranslate">(${escapeHtml(
                vData.turkish
              )})</div>`
            : ""
        }
        <div class="btn-group-compact">
            <button class="btn btn-outline-light btn-sm" onclick="copyConjugations('${verb}')" title="Kopieren">
                <i class="fas fa-copy"></i>
            </button>
            <button class="btn btn-outline-light btn-sm" onclick="speakVerb('${verb}')" title="Vorlesen">
                <i class="fas fa-volume-up"></i>
            </button>
        </div>
    `;
        card.appendChild(header);

        const body = document.createElement("div");
        body.className = "card-body p-2";

        if (
          !vData.conjugations ||
          Object.keys(vData.conjugations).length === 0
        ) {
          const noData = document.createElement("div");
          noData.className = "text-center py-2";
          noData.innerHTML = `<small class="text-muted">Keine Daten</small>`;
          body.appendChild(noData);
        } else {
          const grid = renderConjugationGrid(verb, selectedMoods);
          body.appendChild(grid);
        }

        card.appendChild(body);
        return card;
      }

      function renderConjugationGrid(verb, selectedMoods) {
        const vData = conjugationData[verb];
        if (!vData || !vData.conjugations) return document.createElement("div");

        const container = document.createElement("div");
        container.className = "conjugation-grid-compact";

        const moodGroups = {};
        selectedMoods.forEach((mood) => {
          moodGroups[mood] = [];
        });

        Object.entries(vData.conjugations).forEach(([tenseKey, forms]) => {
          const meta = CONJUGATION_META[tenseKey];
          if (!meta) return;

          let moodCategory;
          if (meta.mood === "Indikativ") moodCategory = "INDIKATIV";
          else if (meta.mood === "Konjunktiv I") moodCategory = "KONJUNKTIV1";
          else if (meta.mood === "Konjunktiv II") moodCategory = "KONJUNKTIV2";

          if (moodGroups[moodCategory]) {
            moodGroups[moodCategory].push({
              tenseKey,
              label: meta.label,
              forms,
            });
          }
        });

        selectedMoods.forEach((mood, mi) => {
          const moodSection = document.createElement("div");
          moodSection.className = "mood-section-compact mb-3";

          const moodTitle = document.createElement("div");
          moodTitle.className =
            "mood-title-compact text-primary mb-2 notranslate";
          moodTitle.textContent = mood
            .replace("KONJUNKTIV", "Konjunktiv ")
            .replace("INDIKATIV", "Indikativ");
          moodSection.appendChild(moodTitle);

          const tenses = moodGroups[mood] || [];
          if (tenses.length === 0) {
            const noData = document.createElement("div");
            noData.className = "text-muted small";
            noData.textContent = "Keine Daten";
            moodSection.appendChild(noData);
            return;
          }

          const tensesContainer = document.createElement("div");
          tensesContainer.className = "tenses-grid-wrapper";

          tenses.forEach((tense) => {
            const tenseBlock = document.createElement("div");
            tenseBlock.className = "tense-block-compact";

            const tenseLabel = document.createElement("div");
            tenseLabel.className = "tense-label-compact notranslate";
            tenseLabel.textContent = tense.label;
            tenseBlock.appendChild(tenseLabel);

            const conjTable = createUltraCompactTable(tense.forms);
            tenseBlock.appendChild(conjTable);

            tensesContainer.appendChild(tenseBlock);
          });

          moodSection.appendChild(tensesContainer);

          container.appendChild(moodSection);
        });

        return container;
      }

      function createUltraCompactTable(tenseObj) {
        const table = document.createElement("table");
        table.className = "conjugation-table-ultra-compact";

        const forms = extractSixForms(tenseObj);

        const tbody = document.createElement("tbody");

        const row1 = document.createElement("tr");
        for (let i = 0; i < 3; i++) {
          const cell = document.createElement("td");
          cell.className = "conj-cell-compact";
          cell.innerHTML = `
            <div class="pronoun-ultra notranslate">${PRONOUNS[i]}</div>
            <div class="form-ultra notranslate">${forms[i] || "-"}</div>
        `;
          row1.appendChild(cell);
        }
        tbody.appendChild(row1);

        const row2 = document.createElement("tr");
        for (let i = 3; i < 6; i++) {
          const cell = document.createElement("td");
          cell.className = "conj-cell-compact";
          cell.innerHTML = `
            <div class="pronoun-ultra notranslate">${PRONOUNS[i]}</div>
            <div class="form-ultra notranslate">${forms[i] || "-"}</div>
        `;
          row2.appendChild(cell);
        }
        tbody.appendChild(row2);

        table.appendChild(tbody);
        return table;
      }

      async function exportAsText() {
        if (exportInProgress) return;
        exportInProgress = true;

        try {
          await conjugateAllVerbsIfNot();
          if (!Object.keys(conjugationData).length) {
            showAlert("Keine Konjugationsdaten vorhanden!", "warning");
            return;
          }

          let txt = "DEUTSCHE VERB KONJUGATIONEN\n";
          txt += "=".repeat(50) + "\n\n";

          Object.keys(conjugationData).forEach((v, index) => {
            const d = conjugationData[v];

            txt += `üìö ${v.toUpperCase()}`;
            if (d.turkish) txt += ` (${d.turkish})`;
            txt += "\n";
            txt += "‚îÄ".repeat(40) + "\n\n";

            const moods = {};
            Object.keys(d.conjugations).forEach((t) => {
              const meta = CONJUGATION_META[t];
              if (!meta) return;

              const mood = meta.mood;
              if (!moods[mood]) moods[mood] = [];
              moods[mood].push({
                tense: t,
                label: meta.label,
                forms: d.conjugations[t],
              });
            });

            Object.entries(moods).forEach(([mood, tenses]) => {
              txt += `üìù ${mood}:\n`;
              tenses.forEach((tense) => {
                txt += `  ${tense.label}:\n`;
                const forms = extractSixForms(tense.forms);
                forms.forEach((form, i) => {
                  txt += `    ${PRONOUNS[i]}: ${form}\n`;
                });
                txt += "\n";
              });
            });

            txt += "\n" + "‚óÜ".repeat(20) + "\n\n";
          });

          downloadFile(txt, "verb_konjugationen.txt", "text/plain");
          showAlert("‚úÖ Text-Export erfolgreich!", "success");
        } finally {
          exportInProgress = false;
        }
      }

      async function exportAsExcel() {
        await conjugateAllVerbsIfNot();
        if (!Object.keys(conjugationData).length) {
          showAlert("Keine Konjugationsdaten vorhanden!", "warning");
          return;
        }

        const verbs = Object.keys(conjugationData);
        const selectedTenses = Object.keys(
          conjugationData[verbs[0]].conjugations
        );

        const wb = XLSX.utils.book_new();

        const moodSheets = {};
        selectedTenses.forEach((t) => {
          const meta = CONJUGATION_META[t];
          if (!meta) return;

          const mood = meta.mood;
          if (!moodSheets[mood]) moodSheets[mood] = [];
          moodSheets[mood].push(t);
        });

        Object.entries(moodSheets).forEach(([mood, tenses]) => {
          const wsData = [];

          const header = [
            "Pronomen",
            ...verbs.map(
              (v) =>
                v +
                (conjugationData[v].turkish
                  ? ` (${conjugationData[v].turkish})`
                  : "")
            ),
          ];
          wsData.push(header);

          tenses.forEach((t) => {
            const tenseLabel = CONJUGATION_META[t].label;
            wsData.push([tenseLabel]);

            PRONOUNS.forEach((p, pi) => {
              const row = [p];
              verbs.forEach((v) => {
                const forms = extractSixForms(
                  conjugationData[v].conjugations[t]
                );
                row.push(forms[pi] || "");
              });
              wsData.push(row);
            });

            wsData.push([]);
          });

          const ws = XLSX.utils.aoa_to_sheet(wsData);

          const colWidths = wsData[0].map((_, ci) => {
            let max = 10;
            wsData.forEach((r) => {
              const v = r[ci] || "";
              if (v.length > max) max = v.length;
            });
            return { wch: Math.min(max + 4, 50) };
          });

          ws["!cols"] = colWidths;

          const range = XLSX.utils.decode_range(ws["!ref"]);
          for (let R = range.s.r; R <= range.e.r; ++R) {
            for (let C = range.s.c; C <= range.e.c; ++C) {
              const cell = ws[XLSX.utils.encode_cell({ r: R, c: C })];
              if (!cell) continue;

              if (R === 0) {
                cell.s = {
                  font: { bold: true, color: { rgb: "FFFFFF" } },
                  fill: { fgColor: { rgb: "3B82F6" } },
                  alignment: { horizontal: "center", vertical: "center" },
                };
              }

              if (C === 0 && R > 0 && !PRONOUNS.includes(cell.v)) {
                cell.s = {
                  font: { bold: true, color: { rgb: "1E40AF" } },
                  fill: { fgColor: { rgb: "E0E7FF" } },
                  alignment: { horizontal: "center", vertical: "center" },
                };
              }
            }
          }

          XLSX.utils.book_append_sheet(wb, ws, mood);
        });

        XLSX.writeFile(wb, "verb_konjugationen_enhanced.xlsx");
        showAlert("‚úÖ Excel-Export erfolgreich!", "success");
      }

      function copyConjugations(verb) {
        const vData = conjugationData[verb];
        if (!vData) return;

        let text = `${verb.toUpperCase()}\n`;
        if (vData.turkish) text += `(${vData.turkish})\n\n`;

        Object.entries(vData.conjugations).forEach(([tense, forms]) => {
          const meta = CONJUGATION_META[tense];
          text += `${meta.label}:\n`;
          const conjugatedForms = extractSixForms(forms);
          conjugatedForms.forEach((form, i) => {
            text += `${PRONOUNS[i]}: ${form}\n`;
          });
          text += "\n";
        });

        navigator.clipboard
          .writeText(text)
          .then(() => {
            showAlert("Konjugationen kopiert!", "success");
          })
          .catch(() => {
            showAlert("Kopieren fehlgeschlagen", "warning");
          });
      }

      function warmUpSpeechSynthesis() {
        if (!("speechSynthesis" in window)) {
          return;
        }

        const loadVoices = () => {
          const voices = speechSynthesis.getVoices();

          if (voices.length > 0 && !window._speechSynthesisWarmedUp) {
            const warmUpUtterance = new SpeechSynthesisUtterance("");
            warmUpUtterance.volume = 0;
            warmUpUtterance.lang = "de-DE";
            warmUpUtterance.onstart = () => {
              window._speechSynthesisWarmedUp = true;
            };
            speechSynthesis.speak(warmUpUtterance);
          }
        };

        loadVoices();

        if (speechSynthesis.getVoices().length === 0) {
          speechSynthesis.addEventListener("voiceschanged", loadVoices, {
            once: true,
          });
        }
      }

      function speakVerb(verb) {
        if ("speechSynthesis" in window) {
          const utterance = new SpeechSynthesisUtterance(verb);
          utterance.lang = "de-DE";
          utterance.rate = 0.8;
          speechSynthesis.speak(utterance);
        } else {
          showAlert("Sprachsynthese nicht verf√ºgbar", "info");
        }
      }

      function speakGrammarText() {
        const textarea = document.getElementById("grammarTextInput");
        if (!textarea) return;

        const text = textarea.value.trim();
        if (!text) {
          showAlert("Bitte geben Sie zuerst einen Text ein", "warning");
          return;
        }

        if ("speechSynthesis" in window) {
          speechSynthesis.cancel();

          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = "de-DE";
          utterance.rate = 0.8;
          speechSynthesis.speak(utterance);
        } else {
          showAlert("Sprachsynthese nicht verf√ºgbar", "info");
        }
      }

      function speakHighlightedText() {
        const highlightedDiv = document.getElementById("highlightedText");
        if (!highlightedDiv) return;

        const errorListDiv = document.getElementById("errorList");
        const hasErrors =
          errorListDiv &&
          errorListDiv.innerHTML &&
          !errorListDiv.innerHTML.includes("Keine Fehler gefunden");

        let textToRead = "";

        if (!hasErrors) {
          const textarea = document.getElementById("grammarTextInput");
          if (textarea) {
            textToRead = textarea.value.trim();
          }
        } else {
          const text =
            highlightedDiv.innerText || highlightedDiv.textContent || "";

          textToRead = text.replace(/Keine Fehler gefunden!.*$/i, "").trim();
        }

        if (!textToRead) {
          showAlert("Kein Text zum Vorlesen verf√ºgbar", "warning");
          return;
        }

        if ("speechSynthesis" in window) {
          speechSynthesis.cancel();

          const utterance = new SpeechSynthesisUtterance(textToRead);
          utterance.lang = "de-DE";
          utterance.rate = 0.8;
          speechSynthesis.speak(utterance);
        } else {
          showAlert("Sprachsynthese nicht verf√ºgbar", "info");
        }
      }

      function addKeyboardShortcuts() {
        document.addEventListener("keydown", function (e) {
          if (e.ctrlKey && e.key === "Enter") {
            e.preventDefault();
            conjugateAllVerbs();
          }

          if (e.key === "Escape") {
            const openModal = document.querySelector(".modal.show");
            if (openModal) {
              const modal = bootstrap.Modal.getInstance(openModal);
              if (modal) modal.hide();
            }
          }

          if (e.altKey && e.key === "n") {
            e.preventDefault();
            document.getElementById("verbInput").focus();
          }

          if (e.altKey && e.key === "c") {
            e.preventDefault();
            clearAllVerbs();
          }
        });
      }

      function showHelp() {
        const helpModal = new bootstrap.Modal(
          document.getElementById("helpModal")
        );
        helpModal.show();
      }

      let grammarErrors = [];
      let originalText = "";
      let lastGrammarCheckTime = 0;
      const GRAMMAR_CHECK_THROTTLE_MS = 10000;

      function switchTab(tabName) {
        const tabMap = {
          conjugation: "conjugation-tab",
          grammar: "grammar-tab",
          dictionary: "dictionary-tab",
          practice: "practice-tab",
          pronunciation: "pronunciation-tab",
          vocabulary: "vocabulary-tab",
          textanalysis: "textanalysis-tab",
        };

        const tabId = tabMap[tabName];
        if (tabId) {
          const tabElement = document.getElementById(tabId);
          if (tabElement) {
            const tabInstance = new bootstrap.Tab(tabElement);
            tabInstance.show();
            localStorage.setItem("activeTab", tabName);

            if (tabName === "vocabulary") {
              setTimeout(() => {
                switchTab("conjugation");
                showAlert(
                  "Vokabeltrainer ist vor√ºbergehend nicht verf√ºgbar.",
                  "info"
                );
              }, 50);
            }
          }
        }
      }

      function restoreActiveTab() {
        const savedTab = localStorage.getItem("activeTab");
        const validTabs = ["conjugation", "grammar"];
        if (validTabs.includes(savedTab)) {
          setTimeout(() => {
            switchTab(savedTab);
          }, 100);
        } else if (savedTab === "vocabulary") {
          setTimeout(() => {
            switchTab("conjugation");
          }, 100);
        }
      }

      function updateTextStats() {
        const textarea = document.getElementById("grammarTextInput");
        const text = textarea.value;
        const charCount = text.length;
        const wordCount =
          text.trim() === "" ? 0 : text.trim().split(/\s+/).length;
        document.getElementById(
          "textStats"
        ).textContent = `${charCount} Zeichen, ${wordCount} W√∂rter`;
      }

      function loadExampleText() {
        const exampleText =
          "Ich habe gestern ein Buch gelesen. Es war sehr interessant und ich habe viel gelernt. Der Autor schreibt sehr gut und die Geschichte ist spannend.";
        document.getElementById("grammarTextInput").value = exampleText;
        updateTextStats();
      }

      function clearGrammarText() {
        document.getElementById("grammarTextInput").value = "";
        document.getElementById("grammarResults").style.display = "none";
        document.getElementById("copyCorrectedBtn").style.display = "none";
        grammarErrors = [];
        originalText = "";
        updateTextStats();
      }

      async function checkGrammarText() {
        const textarea = document.getElementById("grammarTextInput");
        if (!textarea) return;

        const text = textarea.value.trim();
        const loadingDiv = document.getElementById("grammarLoading");
        const resultsDiv = document.getElementById("grammarResults");
        const checkBtn = document.getElementById("checkGrammarBtn");

        if (!text) {
          showAlert("Bitte geben Sie einen Text ein!", "warning");
          return;
        }

        if (!loadingDiv || !resultsDiv || !checkBtn) return;

        const now = Date.now();
        const timeSinceLastRequest = now - lastGrammarCheckTime;

        if (timeSinceLastRequest < GRAMMAR_CHECK_THROTTLE_MS) {
          const remainingSeconds = Math.ceil(
            (GRAMMAR_CHECK_THROTTLE_MS - timeSinceLastRequest) / 1000
          );
          showAlert(
            `Bitte warten Sie ${remainingSeconds} Sekunde${
              remainingSeconds > 1 ? "n" : ""
            } vor der n√§chsten Pr√ºfung. (Rate Limit: 6 Anfragen pro Minute)`,
            "warning"
          );
          return;
        }

        originalText = text;
        lastGrammarCheckTime = now;
        loadingDiv.style.display = "block";
        resultsDiv.style.display = "none";
        checkBtn.disabled = true;

        try {
          const response = await fetch(
            "https://api.languagetool.org/v2/check",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: `text=${encodeURIComponent(text)}&language=de-DE`,
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          grammarErrors = data.matches || [];

          displayGrammarResults(grammarErrors, text);
        } catch (error) {
          console.error("Grammar check error:", error);
          showAlert(
            "Fehler beim Pr√ºfen des Textes. Bitte versuchen Sie es sp√§ter erneut.",
            "danger"
          );
        } finally {
          loadingDiv.style.display = "none";
          checkBtn.disabled = false;
        }
      }

      function displayGrammarResults(errors, text) {
        const resultsDiv = document.getElementById("grammarResults");
        const errorCountDiv = document.getElementById("errorCount");
        const errorListDiv = document.getElementById("errorList");

        if (!resultsDiv || !errorCountDiv || !errorListDiv) return;

        const errorCount = errors.length;
        errorCountDiv.textContent = `${errorCount} ${
          errorCount === 1 ? "Fehler gefunden" : "Fehler gefunden"
        }`;

        const words = text
          .toLowerCase()
          .replace(/[^\w\s√§√∂√º√ü]/g, " ")
          .split(/\s+/)
          .filter((w) => w.length > 0);
        const sentences = text
          .split(/[.!?]+/)
          .filter((s) => s.trim().length > 0);
        const readability = calculateReadability(
          words.length,
          sentences.length,
          text.length
        );

        errorCountDiv.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <span>${errorCount} ${
          errorCount === 1 ? "Fehler gefunden" : "Fehler gefunden"
        }</span>
            <span class="badge bg-info">Lesbarkeit: ${readability.level}</span>
          </div>
        `;

        highlightErrors(text, errors);

        displayErrorList(errors);

        resultsDiv.style.display = "block";
        document.getElementById("copyCorrectedBtn").style.display =
          "inline-block";
      }

      function highlightErrors(text, errors) {
        const highlightedDiv = document.getElementById("highlightedText");
        if (!highlightedDiv) return;

        if (errors.length === 0) {
          highlightedDiv.innerHTML = `<p class="text-success mb-0"><i class="fas fa-check-circle"></i>&nbsp;Keine Fehler gefunden! Der Text ist grammatikalisch korrekt.</p>`;
          return;
        }

        const sortedErrors = [...errors].sort((a, b) => b.offset - a.offset);

        let highlightedText = text;

        sortedErrors.forEach((error) => {
          if (
            !error ||
            typeof error.offset !== "number" ||
            typeof error.length !== "number"
          ) {
            return;
          }

          const start = error.offset;
          const end = start + error.length;

          if (start < 0 || end > highlightedText.length) {
            return;
          }

          const before = highlightedText.substring(0, start);
          const errorText = highlightedText.substring(start, end);
          const after = highlightedText.substring(end);

          const errorMessage = error.message
            ? error.message.replace(/"/g, "&quot;")
            : "Fehler";
          highlightedText = `${before}<mark class="grammar-error" data-error-id="${error.offset}" data-error-offset="${error.offset}" title="${errorMessage} (Klicken f√ºr Details)">${errorText}</mark>${after}`;
        });

        const parts = highlightedText.split(/(<mark[^>]*>.*?<\/mark>)/g);
        let escapedText = parts
          .map((part) => {
            if (part.startsWith("<mark")) {
              const tagMatch = part.match(/^(<mark[^>]*>)(.*?)(<\/mark>)$/);
              if (tagMatch) {
                const [, openTag, content, closeTag] = tagMatch;

                return openTag + escapeHtml(content) + closeTag;
              }
              return part;
            }

            return escapeHtml(part);
          })
          .join("");

        highlightedDiv.innerHTML = escapedText.replace(/\n/g, "<br>");

        highlightedDiv.querySelectorAll(".grammar-error").forEach((mark) => {
          mark.style.cursor = "pointer";
          mark.addEventListener("click", function () {
            const errorOffset = parseInt(
              this.getAttribute("data-error-offset")
            );
            scrollToError(errorOffset);
          });
        });
      }

      function scrollToError(errorOffset) {
        const errorItem = document.querySelector(
          `.error-item[data-error-offset="${errorOffset}"]`
        );

        if (errorItem) {
          const resultsDiv = document.getElementById("grammarResults");
          if (resultsDiv && resultsDiv.style.display === "none") {
            resultsDiv.style.display = "block";
          }

          setTimeout(() => {
            errorItem.scrollIntoView({ behavior: "smooth", block: "center" });

            errorItem.style.transition = "background-color 0.3s ease";
            const originalBg =
              errorItem.style.backgroundColor ||
              window.getComputedStyle(errorItem).backgroundColor;
            errorItem.style.backgroundColor = "rgba(59, 130, 246, 0.2)";

            setTimeout(() => {
              errorItem.style.backgroundColor = originalBg || "";
              setTimeout(() => {
                errorItem.style.transition = "";
              }, 300);
            }, 2000);
          }, 50);
        } else {
          console.warn(
            `Error item with offset ${errorOffset} not found. Available offsets:`,
            Array.from(
              document.querySelectorAll(".error-item[data-error-offset]")
            ).map((el) => el.getAttribute("data-error-offset"))
          );
        }
      }

      function displayErrorList(errors) {
        const errorListDiv = document.getElementById("errorList");

        if (errors.length === 0) {
          errorListDiv.innerHTML =
            '<p class="text-success mb-0"><i class="fas fa-check-circle"></i>&nbsp;Keine Fehler gefunden!</p>';
          return;
        }

        errorListDiv.innerHTML = errors
          .map((error, index) => {
            if (
              !error ||
              typeof error.offset !== "number" ||
              typeof error.length !== "number"
            ) {
              return "";
            }

            const context = originalText.substring(
              Math.max(0, error.offset - 20),
              Math.min(originalText.length, error.offset + error.length + 20)
            );
            const errorText = originalText.substring(
              error.offset,
              error.offset + error.length
            );
            const suggestions = (error.replacements || [])
              .slice(0, 5)
              .map((r) => r?.value)
              .filter((v) => v != null)
              .filter((v, i, a) => a.indexOf(v) === i);

            return `
              <div class="error-item mb-3 p-3 border-start border-4 border-warning bg-light rounded" data-error-offset="${
                error.offset
              }" id="error-${error.offset}">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div>
                    <strong class="text-danger">
                      <i class="fas fa-exclamation-triangle"></i>&nbsp;Fehler ${
                        index + 1
                      }
                    </strong>
                    <span class="badge bg-secondary ms-2">${
                      error.rule.category.name
                    }</span>
                  </div>
                </div>
                <p class="mb-2"><strong>Meldung:</strong> ${escapeHtml(
                  error.message
                )}</p>
                <p class="mb-2 text-muted small">
                  <strong>Kontext:</strong> ...<span class="notranslate">${escapeHtml(
                    context
                  )}</span>...
                </p>
                <p class="mb-2">
                  <strong>Gefunden:</strong> <code class="text-danger notranslate">${escapeHtml(
                    errorText
                  )}</code>
                </p>
                ${
                  suggestions.length > 0
                    ? `
                  <div class="mb-2">
                    <strong>Vorschl√§ge:</strong>
                    <div class="d-flex flex-wrap gap-2 mt-2 notranslate">
                      ${suggestions
                        .map(
                          (suggestion) => `
                        <button
                          class="btn btn-sm btn-outline-primary suggestion-btn"
                          onclick="applySuggestion(${error.offset}, ${
                            error.length
                          }, '${escapeHtml(suggestion).replace(/'/g, "\\'")}')"
                        >
                          ${escapeHtml(suggestion)}
                        </button>
                      `
                        )
                        .join("")}
                    </div>
                  </div>
                `
                    : ""
                }
                <div class="mt-2">
                  <button
                    class="btn btn-sm btn-outline-success"
                    onclick="addErrorWordToVocabulary('${errorText.replace(
                      /'/g,
                      "\\'"
                    )}')"
                    title="Zu Vokabelliste hinzuf√ºgen"
                  >
                    <i class="fas fa-plus"></i>&nbsp;Zu Vokabelliste hinzuf√ºgen
                  </button>
                </div>
              </div>
            `;
          })
          .join("");
      }

      function applySuggestion(offset, length, suggestion) {
        const textarea = document.getElementById("grammarTextInput");
        if (!textarea) return;

        const text = textarea.value;
        const before = text.substring(0, offset);
        const after = text.substring(offset + length);
        const newText = before + suggestion + after;
        textarea.value = newText;
        updateTextStats();

        const errorIndex = grammarErrors.findIndex(
          (error) => error.offset === offset && error.length === length
        );

        if (errorIndex !== -1) {
          const offsetDiff = suggestion.length - length;

          grammarErrors.splice(errorIndex, 1);

          for (let i = errorIndex; i < grammarErrors.length; i++) {
            grammarErrors[i].offset += offsetDiff;
          }

          originalText = newText;

          displayErrorList(grammarErrors);

          highlightErrors(newText, grammarErrors);

          const errorCountDiv = document.getElementById("errorCount");
          if (errorCountDiv) {
            const errorCount = grammarErrors.length;
            errorCountDiv.textContent = `${errorCount} ${
              errorCount === 1 ? "Fehler gefunden" : "Fehler gefunden"
            }`;
          }

          if (grammarErrors.length === 0) {
            document.getElementById("copyCorrectedBtn").style.display = "none";
          }
        } else {
          originalText = newText;
          const highlightedDiv = document.getElementById("highlightedText");
          if (highlightedDiv) {
            highlightedDiv.innerHTML = escapeHtml(newText).replace(
              /\n/g,
              "<br>"
            );
          }
        }

        showAlert("Vorschlag angewendet!", "success");
      }

      function copyCorrectedText() {
        const textarea = document.getElementById("grammarTextInput");
        if (!textarea) return;

        const text = textarea.value;

        navigator.clipboard
          .writeText(text)
          .then(() => {
            showAlert("Text in die Zwischenablage kopiert!", "success");
          })
          .catch(() => {
            showAlert("Kopieren fehlgeschlagen", "warning");
          });
      }

      function clearAnalysisText() {
        document.getElementById("analysisResults").style.display = "none";
      }

      function analyzeText() {
        const textarea = document.getElementById("grammarTextInput");
        if (!textarea) return;

        const text = textarea.value.trim();
        if (!text) {
          showAlert("Bitte geben Sie einen Text ein!", "warning");
          return;
        }

        const words = text
          .toLowerCase()
          .replace(/[^\w\s√§√∂√º√ü-]/g, " ")
          .split(/\s+/)
          .filter((w) => w.length > 0)
          .map((w) => w.trim())
          .filter((w) => w.length > 0);
        const sentences = text
          .split(/[.!?]+/)
          .filter((s) => s.trim().length > 0);
        const characters = text.length;
        const wordCount = words.length;
        const sentenceCount = sentences.length;
        const avgWordsPerSentence =
          sentenceCount > 0 ? (wordCount / sentenceCount).toFixed(1) : 0;

        const wordFreq = {};
        words.forEach((word) => {
          wordFreq[word] = (wordFreq[word] || 0) + 1;
        });

        const sortedWords = Object.entries(wordFreq)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);

        const readabilityScore = calculateReadability(
          wordCount,
          sentenceCount,
          characters
        );

        document.getElementById("readabilityScore").innerHTML = `
          <div class="text-center">
            <h3 class="text-primary">${readabilityScore.level}</h3>
            <p class="text-muted">${readabilityScore.description}</p>
            <div class="progress mt-2">
              <div class="progress-bar" role="progressbar" style="width: ${readabilityScore.score}%">${readabilityScore.score}%</div>
            </div>
          </div>
        `;

        document.getElementById("textStatistics").innerHTML = `
          <ul class="list-unstyled mb-0">
            <li><i class="fas fa-font me-2"></i><strong>Zeichen:</strong> ${characters}</li>
            <li><i class="fas fa-book me-2"></i><strong>W√∂rter:</strong> ${wordCount}</li>
            <li><i class="fas fa-paragraph me-2"></i><strong>S√§tze:</strong> ${sentenceCount}</li>
            <li><i class="fas fa-calculator me-2"></i><strong>W√∂rter/Satz:</strong> ${avgWordsPerSentence}</li>
          </ul>
        `;

        document.getElementById("wordFrequency").innerHTML = `
          <ol class="mb-0">
            ${sortedWords
              .map(
                ([word, count]) =>
                  `<li class="notranslate"><strong>${escapeHtml(
                    word
                  )}</strong> (${count}x)</li>`
              )
              .join("")}
          </ol>
        `;

        const suggestions = generateLearningSuggestions(words, wordFreq);
        document.getElementById("learningSuggestions").innerHTML = `
          <ul class="list-unstyled mb-0">
            ${suggestions
              .map(
                (s) =>
                  `<li class="mb-2"><i class="fas fa-lightbulb text-warning me-2"></i>${escapeHtml(
                    s
                  )}</li>`
              )
              .join("")}
          </ul>
        `;

        document.getElementById("analysisResults").style.display = "block";
      }

      function calculateReadability(wordCount, sentenceCount, charCount) {
        const avgSentenceLength =
          sentenceCount > 0 ? wordCount / sentenceCount : 0;
        const avgWordLength = wordCount > 0 ? charCount / wordCount : 0;

        let score = 100;
        if (avgSentenceLength > 20) score -= 20;
        if (avgSentenceLength > 15) score -= 10;
        if (avgWordLength > 6) score -= 15;

        let level = "Sehr einfach";
        let description = "Ideal f√ºr Anf√§nger";

        if (score < 30) {
          level = "Sehr schwierig";
          description = "F√ºr fortgeschrittene Lernende";
        } else if (score < 50) {
          level = "Schwierig";
          description = "F√ºr fortgeschrittene Lernende";
        } else if (score < 70) {
          level = "Mittel";
          description = "F√ºr mittlere Lernende";
        } else if (score < 85) {
          level = "Einfach";
          description = "F√ºr Anf√§nger geeignet";
        }

        return { score, level, description };
      }

      function generateLearningSuggestions(words, wordFreq) {
        const suggestions = [];
        const uniqueWords = new Set(words);

        if (uniqueWords.size < 50) {
          suggestions.push(
            "Ihr Text verwendet relativ wenig verschiedene W√∂rter. Versuchen Sie, Ihren Wortschatz zu erweitern."
          );
        }

        const rareWords = Object.entries(wordFreq).filter(
          ([word, count]) => count === 1 && word.length > 8
        );
        if (rareWords.length > 5) {
          suggestions.push(
            `Sie verwenden ${rareWords.length} seltene W√∂rter. Diese k√∂nnten gute Kandidaten f√ºr Ihr Vokabellernen sein.`
          );
        }

        if (words.length > 200) {
          suggestions.push(
            "Ihr Text ist lang. Versuchen Sie, komplexe S√§tze in einfachere zu unterteilen."
          );
        }

        if (suggestions.length === 0) {
          suggestions.push(
            "Ihr Text zeigt eine gute Balance zwischen Komplexit√§t und Verst√§ndlichkeit."
          );
        }

        return suggestions;
      }

      document.addEventListener("DOMContentLoaded", function () {
        const grammarTextarea = document.getElementById("grammarTextInput");
        if (grammarTextarea) {
          grammarTextarea.addEventListener("input", updateTextStats);
          grammarTextarea.addEventListener("keydown", function (e) {
            if (e.ctrlKey && e.key === "Enter") {
              e.preventDefault();
              checkGrammarText();
            }
          });
          updateTextStats();
        }
      });

      function addFormValidation() {
        const verbInput = document.getElementById("verbInput");

        verbInput.addEventListener("input", function () {
          const value = this.value.trim();

          if (!value) {
            this.classList.remove("is-valid", "is-invalid");
            return;
          }

          const isValid = /^[a-z√§√∂√º√ü]+$/.test(value.toLowerCase());

          if (!isValid) {
            this.classList.add("is-invalid");
            this.classList.remove("is-valid");
          } else {
            this.classList.remove("is-invalid");
            this.classList.add("is-valid");
          }
        });
      }

      async function batchConjugate(verbs) {
        const results = [];
        const batchSize = 5;

        for (let i = 0; i < verbs.length; i += batchSize) {
          const batch = verbs.slice(i, i + batchSize);
          const batchPromises = batch.map((verb) => processVerb(verb));

          const batchResults = await Promise.allSettled(batchPromises);
          results.push(...batchResults);

          updateProgress(Math.min(i + batchSize, verbs.length), verbs.length);
        }

        return results;
      }

      function handleApiError(error, verb) {
        console.error(`API Error for verb ${verb}:`, error);

        const fallbackVerbs = {
          sein: {
            PRASENS: ["bin", "bist", "ist", "sind", "seid", "sind"],
            PRATERITUM: ["war", "warst", "war", "waren", "wart", "waren"],
            PERFEKT: [
              "bin gewesen",
              "bist gewesen",
              "ist gewesen",
              "sind gewesen",
              "seid gewesen",
              "sind gewesen",
            ],
          },
          haben: {
            PRASENS: ["habe", "hast", "hat", "haben", "habt", "haben"],
            PRATERITUM: [
              "hatte",
              "hattest",
              "hatte",
              "hatten",
              "hattet",
              "hatten",
            ],
            PERFEKT: [
              "habe gehabt",
              "hast gehabt",
              "hat gehabt",
              "haben gehabt",
              "habt gehabt",
              "haben gehabt",
            ],
          },
        };

        if (fallbackVerbs[verb]) {
          return { data: fallbackVerbs[verb] };
        }

        throw error;
      }

      function initializeInteractiveAnimations() {
        const conjugationCards = document.querySelectorAll(
          ".conjugation-mini-card"
        );
        conjugationCards.forEach((card) => {
          card.classList.remove("final-final-touch");
          card.classList.add("subtle-interactive");
        });

        const verbCards = document.querySelectorAll(".mobile-card");
        verbCards.forEach((card) => {
          card.classList.remove("final-final-touch");
          card.classList.add("enhanced-interactive");
        });

        const interactiveElements = [
          ".btn-custom",
          ".verb-item",
          ".form-control",
          ".form-check-input",
          ".card-header",
          ".dark-mode-toggle-final-final-enhanced",
        ];

        interactiveElements.forEach((selector) => {
          const elements = document.querySelectorAll(selector);
          elements.forEach((el) => {
            el.classList.add("enhanced-interactive");
          });
        });
      }

      function enableUltraCompactMode() {
        document.body.classList.add("ultra-compact-mode");

        document.querySelectorAll(".card").forEach((card) => {
          card.style.marginBottom = "8px";
        });

        document.querySelectorAll(".mood-section").forEach((section) => {
          section.style.marginBottom = "6px";
        });

        const grids = document.querySelectorAll(".row.g-3");
        grids.forEach((grid) => {
          grid.classList.remove("g-3");
          grid.classList.add("g-1");
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        addFormValidation();

        setTimeout(() => {
          const particles = document.querySelectorAll(".particle");
          particles.forEach((particle, index) => {
            particle.style.animationDelay = `${index * 0.2}s`;
          });
        }, 100);

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add("animate-fade-in-up");
              }
            });
          },
          { threshold: 0.1 }
        );

        setTimeout(() => {
          const cards = document.querySelectorAll(".card");
          cards.forEach((card) => {
            const tabNavigation = card.closest(".tab-navigation");
            if (!tabNavigation) {
              observer.observe(card);
            }
          });
        }, 500);

        setTimeout(() => {
          initializeInteractiveAnimations();
        }, 100);

        setTimeout(() => {
          enableUltraCompactMode();
        }, 500);
      });

      const style = document.createElement("style");
      style.textContent = `
        @keyframes fadeInUp {
          from {
            opacity: 0;
            transform: translateY(30px) scale(0.95);
          }
          to {
            opacity: 1;
            transform: translateY(0) scale(1);
          }
        }
        
        .animate-fade-in-up {
          animation: fadeInUp 0.6s ease-out forwards;
        }
        
        @keyframes slideInDown {
          from {
            transform: translateY(-100%);
            opacity: 0;
          }
          to {
            transform: translateY(0);
            opacity: 1;
          }
        }
        
        @keyframes slideInDownCentered {
          from {
            transform: translateX(-50%) translateY(-100%);
            opacity: 0;
          }
          to {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
          }
        }
        
        .is-valid {
          border-color: var(--success) !important;
          box-shadow: 0 0 0 0.2rem rgba(16, 185, 129, 0.25) !important;
        }
        
        .is-invalid {
          border-color: var(--error) !important;
          box-shadow: 0 0 0 0.2rem rgba(239, 68, 68, 0.25) !important;
        }
        
        .grammar-error {
          transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .grammar-error:hover {
          background-color: rgba(239, 68, 68, 0.3) !important;
          box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }
      `;
      document.head.appendChild(style);
    </script>

    <script>
      let vocabularyList = [];
      let currentPracticeSession = null;
      let currentCardIndex = 0;
      let isCardFlipped = false;
      let sessionStats = { correct: 0, incorrect: 0, reviewed: 0 };

      function loadVocabulary() {
        try {
          const stored = localStorage.getItem("vocabularyList");
          if (stored) {
            vocabularyList = JSON.parse(stored);
          } else {
            vocabularyList = [];
          }
        } catch (error) {
          console.error("Error loading vocabulary:", error);
          vocabularyList = [];
        }
        renderVocabularyList();
        updateStatistics();
        updateReviewQueue();
      }

      function saveVocabulary() {
        try {
          localStorage.setItem(
            "vocabularyList",
            JSON.stringify(vocabularyList)
          );
        } catch (error) {
          console.error("Error saving vocabulary:", error);
          showAlert("Fehler beim Speichern der Vokabeln", "danger");
        }
      }

      function addVocabularyWord() {
        const wordInput = document.getElementById("vocabWordInput");
        const translationInput = document.getElementById(
          "vocabTranslationInput"
        );
        const notesInput = document.getElementById("vocabNotesInput");

        if (!wordInput) return;

        const word = wordInput.value.trim().toLowerCase();
        const translation = translationInput?.value.trim() || "";
        const notes = notesInput?.value.trim() || "";

        if (!word) {
          showAlert("Bitte geben Sie ein deutsches Wort ein!", "warning");
          return;
        }

        if (vocabularyList.some((v) => v.word === word)) {
          showAlert("Dieses Wort existiert bereits in der Liste!", "warning");
          return;
        }

        const newWord = {
          id: Date.now().toString(),
          word: word,
          translation: translation,
          notes: notes,
          difficulty: 0,
          lastReviewed: null,
          nextReview: Date.now(),
          reviewCount: 0,
          correctCount: 0,
          incorrectCount: 0,
          easeFactor: 2.5,
          interval: 1,
        };

        vocabularyList.push(newWord);
        saveVocabulary();
        renderVocabularyList();
        updateStatistics();
        updateReviewQueue();

        wordInput.value = "";
        if (translationInput) translationInput.value = "";
        if (notesInput) notesInput.value = "";

        showAlert("Wort zur Vokabelliste hinzugef√ºgt!", "success");
      }

      function deleteVocabulary(wordId) {
        vocabularyList = vocabularyList.filter((v) => v.id !== wordId);
        saveVocabulary();
        renderVocabularyList();
        updateStatistics();
        updateReviewQueue();
        showAlert("Wort gel√∂scht!", "success");
      }

      function updateVocabulary(wordId, data) {
        const index = vocabularyList.findIndex((v) => v.id === wordId);
        if (index !== -1) {
          vocabularyList[index] = { ...vocabularyList[index], ...data };
          saveVocabulary();
          renderVocabularyList();
          updateStatistics();
        }
      }

      function renderVocabularyList() {
        const container = document.getElementById("vocabularyList");
        if (!container) return;

        const searchTerm =
          document.getElementById("vocabSearchInput")?.value.toLowerCase() ||
          "";
        const filtered = vocabularyList.filter(
          (v) =>
            v.word.toLowerCase().includes(searchTerm) ||
            v.translation.toLowerCase().includes(searchTerm)
        );

        if (filtered.length === 0) {
          container.innerHTML =
            '<p class="text-muted text-center">Keine Vokabeln gefunden.</p>';
          return;
        }

        container.innerHTML = filtered
          .map((vocab) => {
            const dueDate = new Date(vocab.nextReview);
            const isDue = dueDate <= new Date();
            const dueBadge = isDue
              ? '<span class="badge bg-danger">F√§llig</span>'
              : "";

            return `
              <div class="vocabulary-list-item card mb-2">
                <div class="card-body p-2">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <strong>${escapeHtml(vocab.word)}</strong>
                      ${
                        vocab.translation
                          ? `<br><small class="text-muted">${escapeHtml(
                              vocab.translation
                            )}</small>`
                          : ""
                      }
                      ${
                        vocab.notes
                          ? `<br><small class="text-muted">${escapeHtml(
                              vocab.notes
                            )}</small>`
                          : ""
                      }
                      ${dueBadge}
                    </div>
                    <div class="btn-group btn-group-sm">
                      <button class="btn btn-outline-primary" onclick="editVocabulary('${
                        vocab.id
                      }')" title="Bearbeiten">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-outline-danger" onclick="deleteVocabulary('${
                        vocab.id
                      }')" title="L√∂schen">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            `;
          })
          .join("");
      }

      function editVocabulary(wordId) {
        const vocab = vocabularyList.find((v) => v.id === wordId);
        if (!vocab) return;

        const wordInput = document.getElementById("vocabWordInput");
        const translationInput = document.getElementById(
          "vocabTranslationInput"
        );
        const notesInput = document.getElementById("vocabNotesInput");

        if (wordInput) wordInput.value = vocab.word;
        if (translationInput) translationInput.value = vocab.translation || "";
        if (notesInput) notesInput.value = vocab.notes || "";

        deleteVocabulary(wordId);
        showAlert(
          "Wort geladen. Bitte bearbeiten und erneut hinzuf√ºgen.",
          "info"
        );
      }

      function filterVocabularyList() {
        renderVocabularyList();
      }

      function updateStatistics() {
        const total = vocabularyList.length;
        const due = getWordsDueForReview().length;
        const mastered = vocabularyList.filter(
          (v) => v.reviewCount >= 5 && v.correctCount > v.incorrectCount
        ).length;
        const newWords = vocabularyList.filter(
          (v) => v.reviewCount === 0
        ).length;

        const totalEl = document.getElementById("vocabTotalCount");
        const dueEl = document.getElementById("vocabDueCount");
        const masteredEl = document.getElementById("vocabMasteredCount");
        const newEl = document.getElementById("vocabNewCount");

        if (totalEl) totalEl.textContent = total;
        if (dueEl) dueEl.textContent = due;
        if (masteredEl) masteredEl.textContent = mastered;
        if (newEl) newEl.textContent = newWords;
      }

      function calculateNextReview(word, difficulty) {
        const now = Date.now();
        const oneDay = 24 * 60 * 60 * 1000;

        if (difficulty === 0) {
          word.interval = 1;
          word.easeFactor = Math.max(1.3, word.easeFactor - 0.2);
          word.incorrectCount++;
        } else if (difficulty === 1) {
          word.interval = Math.max(1, word.interval * 1.2);
          word.easeFactor = Math.max(1.3, word.easeFactor - 0.15);
          word.correctCount++;
        } else if (difficulty === 2) {
          word.interval = word.interval * word.easeFactor;
          word.correctCount++;
        } else if (difficulty === 3) {
          word.interval = word.interval * word.easeFactor * 1.3;
          word.easeFactor = Math.min(2.5, word.easeFactor + 0.15);
          word.correctCount++;
        }

        word.lastReviewed = now;
        word.nextReview = now + word.interval * oneDay;
        word.reviewCount++;

        return word;
      }

      function getWordsDueForReview() {
        const now = Date.now();
        return vocabularyList.filter((v) => v.nextReview <= now);
      }

      function updateWordProgress(wordId, difficulty) {
        const word = vocabularyList.find((v) => v.id === wordId);
        if (!word) return;

        const updated = calculateNextReview(word, difficulty);
        const index = vocabularyList.findIndex((v) => v.id === wordId);
        if (index !== -1) {
          vocabularyList[index] = updated;
          saveVocabulary();
        }
      }

      function startPracticeSession() {
        const modeSelect = document.getElementById("practiceModeSelect");
        const mode = modeSelect?.value || "due";

        let wordsToPractice = [];
        if (mode === "due") {
          wordsToPractice = getWordsDueForReview();
        } else if (mode === "all") {
          wordsToPractice = [...vocabularyList];
        } else if (mode === "new") {
          wordsToPractice = vocabularyList.filter((v) => v.reviewCount === 0);
        } else if (mode === "learning") {
          wordsToPractice = vocabularyList.filter(
            (v) => v.reviewCount > 0 && v.reviewCount < 5
          );
        }

        if (wordsToPractice.length === 0) {
          showAlert("Keine W√∂rter zum √úben gefunden!", "warning");
          return;
        }

        wordsToPractice = wordsToPractice.sort(() => Math.random() - 0.5);

        currentPracticeSession = wordsToPractice;
        currentCardIndex = 0;
        isCardFlipped = false;
        sessionStats = { correct: 0, incorrect: 0, reviewed: 0 };

        const sessionDiv = document.getElementById("practiceSession");
        const startBtn = document.getElementById("startPracticeBtn");

        if (sessionDiv) sessionDiv.style.display = "block";
        if (startBtn) startBtn.style.display = "none";

        showNextCard();
        updateSessionStats();
      }

      function showNextCard() {
        if (
          !currentPracticeSession ||
          currentCardIndex >= currentPracticeSession.length
        ) {
          endSession();
          return;
        }

        const word = currentPracticeSession[currentCardIndex];
        isCardFlipped = false;

        const flashcard = document.getElementById("flashcard");
        const wordEl = document.getElementById("flashcardWord");
        const translationEl = document.getElementById("flashcardTranslation");
        const notesEl = document.getElementById("flashcardNotes");
        const currentNumEl = document.getElementById("currentCardNum");
        const totalNumEl = document.getElementById("totalCardsNum");
        const progressBar = document.getElementById("practiceProgressBar");

        if (flashcard) {
          flashcard.classList.remove("flipped");
        }
        if (wordEl) wordEl.textContent = word.word;
        if (translationEl)
          translationEl.textContent = word.translation || "Keine √úbersetzung";
        if (notesEl) {
          notesEl.textContent = word.notes || "";
          notesEl.style.display = word.notes ? "block" : "none";
        }
        if (currentNumEl) currentNumEl.textContent = currentCardIndex + 1;
        if (totalNumEl) totalNumEl.textContent = currentPracticeSession.length;
        if (progressBar) {
          const progress =
            ((currentCardIndex + 1) / currentPracticeSession.length) * 100;
          progressBar.style.width = progress + "%";
        }
      }

      function flipCard() {
        if (!currentPracticeSession) return;
        const flashcard = document.getElementById("flashcard");
        if (flashcard) {
          isCardFlipped = !isCardFlipped;
          flashcard.classList.toggle("flipped", isCardFlipped);
        }
      }

      function handleDifficulty(difficulty) {
        if (
          !currentPracticeSession ||
          currentCardIndex >= currentPracticeSession.length
        )
          return;

        const word = currentPracticeSession[currentCardIndex];
        updateWordProgress(word.id, difficulty);

        if (difficulty === 0) {
          sessionStats.incorrect++;
        } else {
          sessionStats.correct++;
        }
        sessionStats.reviewed++;

        updateSessionStats();
        updateStatistics();
        updateReviewQueue();

        currentCardIndex++;
        showNextCard();
      }

      function updateSessionStats() {
        const correctEl = document.getElementById("sessionCorrect");
        const incorrectEl = document.getElementById("sessionIncorrect");
        const reviewedEl = document.getElementById("sessionReviewed");

        if (correctEl) correctEl.textContent = sessionStats.correct;
        if (incorrectEl) incorrectEl.textContent = sessionStats.incorrect;
        if (reviewedEl) reviewedEl.textContent = sessionStats.reviewed;
      }

      function endSession() {
        currentPracticeSession = null;
        currentCardIndex = 0;
        isCardFlipped = false;

        const sessionDiv = document.getElementById("practiceSession");
        const startBtn = document.getElementById("startPracticeBtn");

        if (sessionDiv) sessionDiv.style.display = "none";
        if (startBtn) startBtn.style.display = "block";

        showAlert(
          `√úbung beendet! ${sessionStats.reviewed} W√∂rter wiederholt, ${sessionStats.correct} richtig, ${sessionStats.incorrect} falsch.`,
          "success"
        );
      }

      function updateReviewQueue() {
        const queueDiv = document.getElementById("reviewQueue");
        if (!queueDiv) return;

        const dueWords = getWordsDueForReview();
        if (dueWords.length === 0) {
          queueDiv.innerHTML =
            '<p class="text-muted text-center mb-0">Keine W√∂rter f√§llig f√ºr Wiederholung.</p>';
          return;
        }

        queueDiv.innerHTML = dueWords
          .slice(0, 10)
          .map((v) => {
            const daysOverdue = Math.floor(
              (Date.now() - v.nextReview) / (24 * 60 * 60 * 1000)
            );
            return `
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span><strong>${escapeHtml(v.word)}</strong></span>
                <span class="badge bg-warning">${
                  daysOverdue > 0
                    ? `${daysOverdue} Tag${
                        daysOverdue > 1 ? "e" : ""
                      } √ºberf√§llig`
                    : "Heute"
                }</span>
              </div>
            `;
          })
          .join("");
      }

      function importFromGrammarCheck() {
        const textarea = document.getElementById("grammarTextInput");
        if (!textarea) {
          showAlert(
            "Bitte geben Sie zuerst einen Text in der Grammatikpr√ºfung ein!",
            "warning"
          );
          return;
        }

        const text = textarea.value.trim();
        if (!text) {
          showAlert(
            "Bitte geben Sie zuerst einen Text in der Grammatikpr√ºfung ein!",
            "warning"
          );
          return;
        }

        const words = text
          .toLowerCase()
          .replace(/[^\w\s√§√∂√º√ü-]/g, " ")
          .split(/\s+/)
          .filter((w) => w.length > 2)
          .filter((w, i, a) => a.indexOf(w) === i);

        if (words.length === 0) {
          showAlert("Keine W√∂rter zum Importieren gefunden!", "warning");
          return;
        }

        let imported = 0;
        words.forEach((word) => {
          if (!vocabularyList.some((v) => v.word === word)) {
            const newWord = {
              id:
                Date.now().toString() + Math.random().toString(36).substr(2, 9),
              word: word,
              translation: "",
              notes: "",
              difficulty: 0,
              lastReviewed: null,
              nextReview: Date.now(),
              reviewCount: 0,
              correctCount: 0,
              incorrectCount: 0,
              easeFactor: 2.5,
              interval: 1,
            };
            vocabularyList.push(newWord);
            imported++;
          }
        });

        if (imported > 0) {
          saveVocabulary();
          renderVocabularyList();
          updateStatistics();
          updateReviewQueue();
          showAlert(`${imported} neue W√∂rter importiert!`, "success");
        } else {
          showAlert("Alle W√∂rter sind bereits in der Liste!", "info");
        }
      }

      function speakVocabularyWord() {
        if (
          !currentPracticeSession ||
          currentCardIndex >= currentPracticeSession.length
        )
          return;
        const word = currentPracticeSession[currentCardIndex];
        if (word && word.word) {
          speakVerb(word.word);
        }
      }

      function addErrorWordToVocabulary(wordText) {
        if (!wordText || !wordText.trim()) return;

        const word = wordText.trim().toLowerCase();

        if (vocabularyList.some((v) => v.word === word)) {
          showAlert(
            "Dieses Wort existiert bereits in der Vokabelliste!",
            "info"
          );
          return;
        }

        const newWord = {
          id: Date.now().toString(),
          word: word,
          translation: "",
          notes: `Aus Grammatikpr√ºfung hinzugef√ºgt`,
          difficulty: 0,
          lastReviewed: null,
          nextReview: Date.now(),
          reviewCount: 0,
          correctCount: 0,
          incorrectCount: 0,
          easeFactor: 2.5,
          interval: 1,
        };

        vocabularyList.push(newWord);
        saveVocabulary();
        renderVocabularyList();
        updateStatistics();
        updateReviewQueue();

        showAlert(`"${word}" zur Vokabelliste hinzugef√ºgt!`, "success");
      }

      document.addEventListener("keydown", function (e) {
        const vocabularyPane = document.getElementById("vocabulary-pane");
        if (!vocabularyPane || !vocabularyPane.classList.contains("active"))
          return;
        if (!currentPracticeSession) return;

        if (e.code === "Space" && !isCardFlipped) {
          e.preventDefault();
          flipCard();
        } else if (e.key === "1") {
          e.preventDefault();
          handleDifficulty(0);
        } else if (e.key === "2") {
          e.preventDefault();
          handleDifficulty(1);
        } else if (e.key === "3") {
          e.preventDefault();
          handleDifficulty(2);
        } else if (e.key === "4") {
          e.preventDefault();
          handleDifficulty(3);
        }
      });

      document.addEventListener("DOMContentLoaded", function () {
        loadVocabulary();
      });
    </script>

    <footer class="footer mt-5 py-4 bg-light border-top">
      <div class="container-final-final-enhanced">
        <div class="row align-items-center">
          <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
            <p class="mb-0 text-muted">
              <small>
                <i class="fas fa-info-circle me-1"></i>
                Version <span id="version-info">v1.7</span>
              </small>
            </p>
            <p class="mb-0 text-muted">
              <small>
                <i class="fas fa-code-branch me-1"></i>
                <a
                  href="https://github.com/diviverse/smsk/tree/main/deutsch"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-decoration-none"
                >
                  View on GitHub
                  <i
                    class="fas fa-external-link-alt ms-1"
                    style="font-size: 0.75em"
                  ></i>
                </a>
              </small>
            </p>
          </div>
        </div>
      </div>
    </footer>
  </body>
</html>
